<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Vriskas Clicker</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
--bg:#000;--bg2:#111;--bg3:#1a1a1a;--card:#1c1c1e;--card2:#2c2c2e;
--text:#fff;--text2:#aaa;--text3:#666;
--accent:#007aff;--accent2:#5856d6;--green:#34c759;--red:#ff3b30;
--orange:#ff9500;--yellow:#ffd60a;--pink:#ff2d55;--cyan:#5ac8fa;
--radius:14px;--shadow:0 2px 12px rgba(0,0,0,0.3);
--transition:0.3s cubic-bezier(0.25,0.46,0.45,0.94);
}
.theme-light{
--bg:#f2f2f7;--bg2:#e5e5ea;--bg3:#d1d1d6;--card:#fff;--card2:#f2f2f7;
--text:#000;--text2:#666;--text3:#999;--shadow:0 2px 12px rgba(0,0,0,0.08);
}
body{
font-family:'Inter',system-ui,-apple-system,sans-serif;
background:var(--bg);color:var(--text);
overflow:hidden;height:100vh;width:100vw;
user-select:none;-webkit-user-select:none;
}
/* iOS style (default) */
.style-ios .card{border-radius:var(--radius);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.style-ios .btn{border-radius:10px}
.style-ios .tab-bar{border-radius:0}

/* Material You style */
.style-material{--radius:28px}
.style-material .card{border-radius:var(--radius);box-shadow:0 1px 3px rgba(0,0,0,0.12),0 4px 8px rgba(0,0,0,0.06)}
.style-material .btn{border-radius:20px;font-weight:600;letter-spacing:0.3px;position:relative;overflow:hidden}
.style-material .btn::after{
content:'';position:absolute;inset:0;background:radial-gradient(circle at var(--rx,50%) var(--ry,50%),rgba(255,255,255,0.3) 0%,transparent 60%);
opacity:0;transition:opacity 0.5s;pointer-events:none;
}
.style-material .btn:active::after{opacity:1;transition:opacity 0s}
.style-material .tab-bar{border-radius:20px 20px 0 0;margin:0 8px}
.style-material .tab-item{border-radius:16px}
.style-material .tab-item.active{background:rgba(var(--accent-rgb,0,122,255),0.15)}
.style-material .shop-item{border-radius:24px}
.style-material input,.style-material select{border-radius:16px!important}

/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--text3);border-radius:2px}

/* Layout */
.app{height:100vh;display:flex;flex-direction:column;position:relative;overflow:hidden}
.header{padding:12px 16px 8px;display:flex;align-items:center;justify-content:space-between;z-index:10;flex-shrink:0}
.header-left{display:flex;align-items:center;gap:8px}
.header-avatar{width:36px;height:36px;border-radius:50%;background:var(--card);border:2px solid var(--accent);overflow:hidden;display:flex;align-items:center;justify-content:center}
.header-avatar img{width:100%;height:100%;object-fit:cover}
.header-name{font-size:14px;font-weight:600}
.header-level{font-size:11px;color:var(--accent);font-weight:500}
.header-right{display:flex;gap:12px;align-items:center}
.header-stat{display:flex;align-items:center;gap:4px;font-size:13px;font-weight:600}
.header-stat svg{width:16px;height:16px}

/* Pages */
.pages-container{flex:1;overflow:hidden;position:relative}
.page{position:absolute;inset:0;overflow-y:auto;padding:8px 16px 16px;opacity:0;transform:scale(0.95);transition:all 0.35s cubic-bezier(0.25,0.46,0.45,0.94);pointer-events:none;will-change:transform,opacity}
.page.active{opacity:1;transform:scale(1);pointer-events:auto}
.page::-webkit-scrollbar{display:none}

/* Tab Bar */
.tab-bar{
position:fixed;bottom:0;left:0;right:0;
background:var(--card);border-top:1px solid rgba(255,255,255,0.05);
display:flex;padding:6px 4px calc(env(safe-area-inset-bottom,8px) + 6px);
z-index:100;flex-shrink:0;
}
.tab-item{
flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;
padding:6px 2px;cursor:pointer;transition:all 0.2s;border-radius:10px;
}
.tab-item svg{width:22px;height:22px;color:var(--text3);transition:all 0.2s}
.tab-item span{font-size:9px;color:var(--text3);font-weight:500;transition:all 0.2s}
.tab-item.active svg{color:var(--accent)}
.tab-item.active span{color:var(--accent)}
.tab-item:active{transform:scale(0.85)}
.tab-item .notif{position:absolute;top:2px;right:50%;transform:translateX(12px);width:8px;height:8px;background:var(--red);border-radius:50%;border:2px solid var(--card)}

/* Card */
.card{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow);transition:all var(--transition)}
.card-title{font-size:15px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.card-title svg{width:20px;height:20px}

/* Button */
.btn{
display:flex;align-items:center;justify-content:center;gap:8px;
padding:12px 16px;border:none;border-radius:10px;
font-family:inherit;font-size:14px;font-weight:600;
cursor:pointer;transition:all 0.15s;width:100%;color:#fff;
}
.btn:active{transform:scale(0.96)}
.btn-primary{background:var(--accent)}
.btn-green{background:var(--green)}
.btn-red{background:var(--red)}
.btn-orange{background:var(--orange)}
.btn-pink{background:var(--pink)}
.btn-dark{background:var(--card2);color:var(--text)}
.btn-outline{background:transparent;border:2px solid var(--accent);color:var(--accent)}
.btn:disabled{opacity:0.4;pointer-events:none}

/* Clicker Page */
.clicker-area{display:flex;flex-direction:column;align-items:center;padding-top:8px}
.clicker-stats{display:flex;gap:16px;margin-bottom:8px}
.clicker-stat{text-align:center}
.clicker-stat-val{font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.clicker-stat-lbl{font-size:10px;color:var(--text2);font-weight:500}

.level-bar{width:100%;margin:8px 0 12px}
.level-info{display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:4px}
.level-track{height:6px;background:var(--card2);border-radius:3px;overflow:hidden}
.level-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width 0.5s}

.coin-wrap{position:relative;margin:16px 0}
.coin-ring{position:absolute;inset:-20px;border-radius:50%;border:2px solid var(--accent);opacity:0.2;animation:coinPulse 2s infinite}
@keyframes coinPulse{0%,100%{transform:scale(0.9);opacity:0.1}50%{transform:scale(1.05);opacity:0.3}}
.coin-btn{
width:160px;height:160px;border-radius:50%;border:none;cursor:pointer;
position:relative;transition:transform 0.1s;
background:radial-gradient(circle at 35% 35%,#ffd700,#f0a000,#c87800);
box-shadow:0 8px 32px rgba(255,180,0,0.4),inset 0 -4px 8px rgba(0,0,0,0.3),inset 0 4px 8px rgba(255,255,255,0.3);
}
.coin-btn:active{transform:scale(0.92)}
.coin-btn svg{width:80px;height:80px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
.coin-bg{position:absolute;inset:0;pointer-events:none;overflow:hidden;border-radius:50%}

.combo-bar{margin:12px 0 4px;text-align:center}
.combo-text{font-size:13px;font-weight:700;color:var(--orange)}
.combo-track{height:4px;background:var(--card2);border-radius:2px;margin-top:4px;overflow:hidden}
.combo-fill{height:100%;background:linear-gradient(90deg,var(--orange),var(--red));border-radius:2px;transition:width 0.3s}

.energy-bar{width:100%;margin:8px 0}
.energy-info{display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:4px}
.energy-track{height:8px;background:var(--card2);border-radius:4px;overflow:hidden}
.energy-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--cyan));border-radius:4px;transition:width 0.3s}
.energy-fill.low{background:linear-gradient(90deg,var(--red),var(--orange))}

.floating-text{
position:fixed;pointer-events:none;font-weight:800;
animation:floatUp 1s forwards;z-index:999;
}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(0.5)}}

.clicker-bg-particle{
position:absolute;border-radius:50%;pointer-events:none;opacity:0.1;
animation:particleFloat 8s infinite ease-in-out;
}
@keyframes particleFloat{
0%,100%{transform:translateY(0) rotate(0deg)}
25%{transform:translateY(-30px) rotate(90deg)}
50%{transform:translateY(-10px) rotate(180deg)}
75%{transform:translateY(-40px) rotate(270deg)}
}

/* Golden coin */
.golden-coin{
position:absolute;width:44px;height:44px;cursor:pointer;z-index:50;
animation:goldenBounce 0.6s infinite alternate;
filter:drop-shadow(0 0 12px gold);
}
@keyframes goldenBounce{0%{transform:scale(1) rotate(-5deg)}100%{transform:scale(1.15) rotate(5deg)}}

/* Shop */
.shop-tabs{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px}
.shop-tab{
padding:8px 14px;border-radius:10px;font-size:12px;font-weight:600;
cursor:pointer;white-space:nowrap;background:var(--card2);color:var(--text2);
transition:all 0.2s;flex-shrink:0;
}
.shop-tab.active{background:var(--accent);color:#fff}
.shop-item{
background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:8px;
display:flex;align-items:center;gap:12px;box-shadow:var(--shadow);
}
.shop-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
.shop-info{flex:1;min-width:0}
.shop-name{font-size:13px;font-weight:700}
.shop-desc{font-size:11px;color:var(--text2);margin-top:2px}
.shop-meta{display:flex;gap:8px;margin-top:4px}
.shop-lvl{font-size:10px;color:var(--accent);font-weight:600}
.shop-btn{
padding:8px 14px;border:none;border-radius:8px;font-family:inherit;
font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;
display:flex;align-items:center;gap:4px;flex-shrink:0;
}
.shop-btn.affordable{background:var(--accent);color:#fff}
.shop-btn.expensive{background:var(--card2);color:var(--text3)}
.shop-btn svg{width:14px;height:14px}

/* Skins */
.skins-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.skin-card{
background:var(--card);border-radius:var(--radius);padding:12px;text-align:center;
cursor:pointer;transition:all 0.2s;border:2px solid transparent;
}
.skin-card.active{border-color:var(--accent)}
.skin-card.locked{opacity:0.5}
.skin-svg{width:56px;height:56px;margin:0 auto 6px}
.skin-name{font-size:11px;font-weight:600}
.skin-bonus{font-size:9px;color:var(--green);margin-top:2px}
.skin-price{font-size:10px;color:var(--orange);margin-top:2px}

/* Achievements */
.ach-item{
display:flex;align-items:center;gap:10px;padding:10px;
background:var(--card);border-radius:12px;margin-bottom:6px;
}
.ach-item.done{border-left:3px solid var(--green)}
.ach-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.ach-info{flex:1;min-width:0}
.ach-name{font-size:12px;font-weight:600}
.ach-desc{font-size:10px;color:var(--text2);margin-top:1px}
.ach-prog{height:3px;background:var(--card2);border-radius:2px;margin-top:4px;overflow:hidden}
.ach-prog-fill{height:100%;background:var(--accent);border-radius:2px}
.ach-reward{font-size:10px;color:var(--yellow);font-weight:600;flex-shrink:0}

/* Quest */
.quest-item{
display:flex;align-items:center;gap:10px;padding:12px;
background:var(--card);border-radius:12px;margin-bottom:6px;
}
.quest-item.done{opacity:0.5}
.quest-icon{font-size:22px;flex-shrink:0}
.quest-info{flex:1}
.quest-name{font-size:12px;font-weight:600}
.quest-prog{height:4px;background:var(--card2);border-radius:2px;margin-top:4px;overflow:hidden}
.quest-prog-fill{height:100%;background:var(--green);border-radius:2px}
.quest-reward{font-size:10px;color:var(--yellow);font-weight:600;flex-shrink:0}

/* Battle */
.battle-card{
background:var(--card);border-radius:var(--radius);padding:20px;
text-align:center;margin-bottom:12px;
}
.battle-title{font-size:16px;font-weight:800;margin-bottom:6px}

/* Boss overlay */
.boss-overlay{
position:fixed;inset:0;z-index:200;
background:rgba(0,0,0,0.9);
display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;
}
.boss-overlay.show{display:flex}
.boss-sprite{width:120px;height:120px;margin-bottom:16px;transition:transform 0.1s}
.boss-sprite.shake{animation:bossShake 0.15s}
@keyframes bossShake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px) rotate(-3deg)}75%{transform:translateX(8px) rotate(3deg)}}
.boss-hp{width:80%;max-width:300px;margin:12px 0}
.boss-hp-track{height:12px;background:#333;border-radius:6px;overflow:hidden}
.boss-hp-fill{height:100%;background:linear-gradient(90deg,var(--red),var(--orange));border-radius:6px;transition:width 0.2s}
.boss-timer{font-size:28px;font-weight:900;color:var(--red);margin:8px 0}
.boss-tap-btn{
width:140px;height:140px;border-radius:50%;border:none;cursor:pointer;
background:radial-gradient(circle at 35% 35%,var(--red),#8b0000);
box-shadow:0 8px 32px rgba(255,0,0,0.4);
display:flex;align-items:center;justify-content:center;
margin-top:16px;transition:transform 0.1s;
}
.boss-tap-btn:active{transform:scale(0.9)}

/* Duel overlay */
.duel-overlay{
position:fixed;inset:0;z-index:200;
background:rgba(0,0,0,0.95);
display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;
}
.duel-overlay.show{display:flex}
.duel-vs{display:flex;align-items:center;gap:20px;margin:16px 0}
.duel-player{text-align:center}
.duel-player-avatar{width:56px;height:56px;border-radius:50%;background:var(--card);margin:0 auto 8px;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid var(--accent)}
.duel-player-avatar img{width:100%;height:100%;object-fit:cover}
.duel-player-name{font-size:12px;font-weight:600}
.duel-player-taps{font-size:28px;font-weight:900;color:var(--accent)}
.duel-timer{font-size:48px;font-weight:900;color:var(--yellow)}
.duel-tap-btn{
width:140px;height:140px;border-radius:50%;border:none;cursor:pointer;
background:radial-gradient(circle at 35% 35%,var(--accent),var(--accent2));
box-shadow:0 8px 32px rgba(0,122,255,0.4);
display:flex;align-items:center;justify-content:center;
margin-top:16px;transition:transform 0.1s;
}
.duel-tap-btn:active{transform:scale(0.9)}

/* Leaderboard */
.lb-tabs{display:flex;gap:6px;margin-bottom:12px}
.lb-tab{flex:1;padding:8px;border-radius:10px;text-align:center;font-size:12px;font-weight:600;cursor:pointer;background:var(--card2);color:var(--text2);transition:all 0.2s}
.lb-tab.active{background:var(--accent);color:#fff}
.lb-item{
display:flex;align-items:center;gap:10px;padding:10px;
background:var(--card);border-radius:12px;margin-bottom:6px;
}
.lb-item.me{border:2px solid var(--accent)}
.lb-rank{width:28px;font-size:14px;font-weight:800;text-align:center;flex-shrink:0}
.lb-avatar{width:36px;height:36px;border-radius:50%;background:var(--card2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.lb-avatar img{width:100%;height:100%;object-fit:cover}
.lb-info{flex:1;min-width:0}
.lb-name{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lb-sub{font-size:10px;color:var(--text2)}
.lb-val{font-size:13px;font-weight:700;color:var(--accent);flex-shrink:0}

/* Profile */
.profile-header{text-align:center;padding:20px 0}
.profile-avatar{width:80px;height:80px;border-radius:50%;margin:0 auto 12px;background:var(--card2);overflow:hidden;border:3px solid var(--accent);display:flex;align-items:center;justify-content:center}
.profile-avatar img{width:100%;height:100%;object-fit:cover}
.profile-name{font-size:18px;font-weight:800}
.profile-username{font-size:13px;color:var(--text2);margin-top:2px}
.profile-badges{display:flex;gap:6px;justify-content:center;margin-top:8px;flex-wrap:wrap}
.badge{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;background:var(--card2);color:var(--text2)}
.badge.gold{background:rgba(255,214,10,0.2);color:var(--yellow)}

.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin:12px 0}
.stat-card{background:var(--card);border-radius:12px;padding:12px;text-align:center}
.stat-val{font-size:18px;font-weight:800;color:var(--accent)}
.stat-lbl{font-size:10px;color:var(--text2);margin-top:2px}

/* Settings */
.setting-row{
display:flex;align-items:center;justify-content:space-between;
padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.05);
}
.setting-label{font-size:14px;font-weight:500}
.setting-desc{font-size:11px;color:var(--text2);margin-top:2px}
.toggle{
width:50px;height:30px;border-radius:15px;background:var(--card2);
position:relative;cursor:pointer;transition:background 0.3s;flex-shrink:0;
}
.toggle.on{background:var(--green)}
.toggle-knob{
width:26px;height:26px;border-radius:50%;background:#fff;
position:absolute;top:2px;left:2px;transition:transform 0.3s;
box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.toggle.on .toggle-knob{transform:translateX(20px)}

/* Roulette */
.roulette-wrap{position:relative;width:260px;height:260px;margin:0 auto}
.roulette-canvas{width:260px;height:260px}
.roulette-pointer{position:absolute;top:-8px;left:50%;transform:translateX(-50%);font-size:24px}

/* Event banner */
.event-banner{
background:linear-gradient(135deg,var(--accent),var(--accent2));
border-radius:var(--radius);padding:12px 16px;margin-bottom:12px;
display:none;align-items:center;gap:10px;
}
.event-banner.show{display:flex}
.event-banner-text{font-size:12px;font-weight:600;color:#fff}
.event-banner-timer{font-size:11px;color:rgba(255,255,255,0.8)}

/* Pets */
.pets-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.pet-card{
background:var(--card);border-radius:var(--radius);padding:14px;text-align:center;
cursor:pointer;transition:all 0.2s;border:2px solid transparent;
}
.pet-card.active{border-color:var(--green)}
.pet-card.locked{opacity:0.4}
.pet-icon{font-size:36px;margin-bottom:6px}
.pet-name{font-size:12px;font-weight:700}
.pet-bonus{font-size:10px;color:var(--green);margin-top:2px}

/* Artifacts */
.artifact-card{
display:flex;align-items:center;gap:12px;padding:12px;
background:var(--card);border-radius:12px;margin-bottom:8px;
border:2px solid transparent;cursor:pointer;
}
.artifact-card.active{border-color:var(--yellow)}
.artifact-card.locked{opacity:0.4}
.artifact-icon{font-size:28px;flex-shrink:0}

/* Worlds */
.world-card{
background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:8px;
display:flex;align-items:center;gap:12px;cursor:pointer;
border:2px solid transparent;transition:all 0.2s;
}
.world-card.active{border-color:var(--accent);background:rgba(var(--accent-rgb,0,122,255),0.1)}
.world-card.locked{opacity:0.4;pointer-events:none}

/* Code input */
.code-input-wrap{display:flex;gap:8px}
.code-input{
flex:1;padding:12px;border-radius:10px;border:2px solid var(--card2);
background:var(--card);color:var(--text);font-family:inherit;font-size:14px;
outline:none;transition:border-color 0.2s;
}
.code-input:focus{border-color:var(--accent)}

/* Admin */
.admin-section{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:12px;border:2px solid var(--red)}
.admin-title{font-size:14px;font-weight:700;color:var(--red);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.admin-player{
display:flex;align-items:center;gap:8px;padding:10px;
background:var(--bg);border-radius:10px;margin-bottom:6px;
}
.admin-player.banned{border-left:3px solid var(--red);opacity:0.6}
.admin-input{
width:100%;padding:10px;border-radius:8px;border:1px solid var(--card2);
background:var(--bg);color:var(--text);font-family:inherit;font-size:13px;
outline:none;margin-bottom:8px;
}

/* Toast */
.toast{
position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-100px);
background:var(--card);color:var(--text);padding:12px 20px;border-radius:12px;
font-size:13px;font-weight:600;z-index:300;transition:transform 0.4s;
box-shadow:0 8px 32px rgba(0,0,0,0.3);max-width:90%;text-align:center;
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* Modal */
.modal-overlay{
position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:250;
display:none;align-items:flex-end;justify-content:center;
}
.modal-overlay.show{display:flex}
.modal{
background:var(--card);border-radius:20px 20px 0 0;padding:24px;
width:100%;max-width:500px;max-height:80vh;overflow-y:auto;
animation:modalSlide 0.3s;
}
@keyframes modalSlide{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--text3);border-radius:2px;margin:0 auto 16px}
.modal-title{font-size:17px;font-weight:800;margin-bottom:16px;text-align:center}

/* Banned screen */
.banned-screen{
position:fixed;inset:0;z-index:999;background:var(--bg);
display:none;flex-direction:column;align-items:center;justify-content:center;padding:40px;
}
.banned-screen.show{display:flex}
.banned-icon{font-size:64px;margin-bottom:16px}
.banned-title{font-size:24px;font-weight:900;color:var(--red);margin-bottom:8px}
.banned-text{font-size:14px;color:var(--text2);text-align:center}

/* Cheater screen */
.cheater-screen{
position:fixed;inset:0;z-index:999;background:#1a0000;
display:none;flex-direction:column;align-items:center;justify-content:center;padding:40px;
}
.cheater-screen.show{display:flex}

/* Clicker background */
.clicker-bg{
position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:0;
}
.clicker-bg::before{
content:'';position:absolute;
width:300px;height:300px;border-radius:50%;
background:radial-gradient(circle,rgba(var(--accent-rgb,0,122,255),0.08) 0%,transparent 70%);
top:50%;left:50%;transform:translate(-50%,-50%);
}
</style>
</head>
<body class="style-ios">

<div class="app" id="app">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="header-avatar" id="headerAvatar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div>
        <div class="header-name" id="headerName">–ò–≥—Ä–æ–∫</div>
        <div class="header-level" id="headerLevel">–£—Ä. 1</div>
      </div>
    </div>
    <div class="header-right">
      <div class="header-stat">
        <svg viewBox="0 0 24 24" fill="var(--yellow)"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="12" font-weight="bold" fill="#000">$</text></svg>
        <span id="headerCoins">0</span>
      </div>
      <div class="header-stat">
        <svg viewBox="0 0 24 24" fill="none" stroke="var(--cyan)" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>
        <span id="headerStars">0</span>
      </div>
    </div>
  </div>

  <!-- Pages -->
  <div class="pages-container">
    <!-- Page 0: Clicker -->
    <div class="page active" id="page-0">
      <div class="clicker-bg" id="clickerBg"></div>
      <div style="position:relative;z-index:1">
        <div class="event-banner" id="eventBanner">
          <span class="event-banner-text" id="eventText"></span>
          <span class="event-banner-timer" id="eventTimer"></span>
        </div>
        <div class="clicker-area">
          <div class="clicker-stats">
            <div class="clicker-stat"><div class="clicker-stat-val" id="cpsDisplay">0</div><div class="clicker-stat-lbl">–≤ —Å–µ–∫—É–Ω–¥—É</div></div>
            <div class="clicker-stat"><div class="clicker-stat-val" id="perTapDisplay">1</div><div class="clicker-stat-lbl">–∑–∞ —Ç–∞–ø</div></div>
            <div class="clicker-stat"><div class="clicker-stat-val" id="totalTapsDisplay">0</div><div class="clicker-stat-lbl">—Ç–∞–ø–æ–≤</div></div>
          </div>
          <div class="level-bar">
            <div class="level-info"><span id="levelName">–ù–æ–≤–∏—á–æ–∫</span><span id="levelProg">0%</span></div>
            <div class="level-track"><div class="level-fill" id="levelFill" style="width:0%"></div></div>
          </div>
          <div class="coin-wrap">
            <div class="coin-ring"></div>
            <button class="coin-btn" id="coinBtn" ontouchstart="doClick(event)" onmousedown="doClick(event)">
              <svg id="coinSvg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="#ffd700" stroke="#c87800" stroke-width="3"/><text x="50" y="58" text-anchor="middle" font-size="36" font-weight="bold" fill="#8B6914">V</text></svg>
            </button>
          </div>
          <div class="combo-bar" id="comboBar" style="display:none">
            <div class="combo-text" id="comboText">COMBO x1</div>
            <div class="combo-track"><div class="combo-fill" id="comboFill" style="width:100%"></div></div>
          </div>
          <div class="energy-bar">
            <div class="energy-info"><span>‚ö° –≠–Ω–µ—Ä–≥–∏—è</span><span id="energyText">500/500</span></div>
            <div class="energy-track"><div class="energy-fill" id="energyFill" style="width:100%"></div></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:12px;width:100%">
            <button class="btn btn-dark" style="flex:1;font-size:12px" onclick="openRoulette()">üé∞ –†—É–ª–µ—Ç–∫–∞</button>
            <button class="btn btn-dark" style="flex:1;font-size:12px" onclick="openCodeInput()">üîë –ö–æ–¥</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Page 1: Shop -->
    <div class="page" id="page-1">
      <div class="shop-tabs" id="shopTabs"></div>
      <div id="shopList"></div>
    </div>

    <!-- Page 2: Collection (Skins + Pets + Artifacts + Worlds) -->
    <div class="page" id="page-2">
      <div class="shop-tabs" id="collTabs">
        <div class="shop-tab active" onclick="switchCollTab(0)">üé® –°–∫–∏–Ω—ã</div>
        <div class="shop-tab" onclick="switchCollTab(1)">üêæ –ü–∏—Ç–æ–º—Ü—ã</div>
        <div class="shop-tab" onclick="switchCollTab(2)">üîÆ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã</div>
        <div class="shop-tab" onclick="switchCollTab(3)">üåç –ú–∏—Ä—ã</div>
      </div>
      <div id="collContent"></div>
    </div>

    <!-- Page 3: Achievements + Quests -->
    <div class="page" id="page-3">
      <div class="shop-tabs">
        <div class="shop-tab active" id="aqTab0" onclick="switchAQTab(0)">üèÖ –ê—á–∏–≤–∫–∏</div>
        <div class="shop-tab" id="aqTab1" onclick="switchAQTab(1)">üìã –ö–≤–µ—Å—Ç—ã</div>
      </div>
      <div id="aqContent"></div>
    </div>

    <!-- Page 4: Battle (Boss + Duel) -->
    <div class="page" id="page-4">
      <div class="battle-card">
        <div class="battle-title">üëπ –ë–æ—Å—Å</div>
        <p style="font-size:12px;color:var(--text2);margin:8px 0">–£–±–∏—Ç–æ –±–æ—Å—Å–æ–≤: <span id="bossKills">0</span></p>
        <button class="btn btn-red" id="bossStartBtn" onclick="startBoss()">‚öîÔ∏è –í—ã–∑–≤–∞—Ç—å –±–æ—Å—Å–∞</button>
      </div>
      <div class="battle-card">
        <div class="battle-title">‚öîÔ∏è –î—É—ç–ª—å PvP</div>
        <p style="font-size:12px;color:var(--text2);margin:8px 0">30 —Å–µ–∫—É–Ω–¥ ‚Äî –∫—Ç–æ –Ω–∞—Ç–∞–ø–∞–µ—Ç –±–æ–ª—å—à–µ!</p>
        <p style="font-size:11px;color:var(--orange);margin-bottom:8px">–°—Ç–∞–≤–∫–∞: 5,000 –º–æ–Ω–µ—Ç</p>
        <button class="btn btn-primary" id="duelBtn" onclick="startDuel()">üîç –ù–∞–π—Ç–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</button>
        <p style="font-size:11px;color:var(--text2);margin-top:8px">–ü–æ–±–µ–¥: <span id="duelWins">0</span> | –ü–æ—Ä–∞–∂–µ–Ω–∏–π: <span id="duelLosses">0</span></p>
      </div>
    </div>

    <!-- Page 5: Leaderboard -->
    <div class="page" id="page-5">
      <div class="lb-tabs">
        <div class="lb-tab active" id="lbTab0" onclick="switchLbTab(0)">üí∞ –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
        <div class="lb-tab" id="lbTab1" onclick="switchLbTab(1)">üëÜ –¢–∞–ø–æ–≤</div>
      </div>
      <div id="lbList"><div style="text-align:center;padding:40px;color:var(--text2)">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    </div>

    <!-- Page 6: Profile -->
    <div class="page" id="page-6">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--text2)" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
        <div class="profile-name" id="profileName">–ò–≥—Ä–æ–∫</div>
        <div class="profile-username" id="profileUsername">@username</div>
        <div class="profile-badges" id="profileBadges"></div>
      </div>
      <div class="stats-grid" id="statsGrid"></div>
      <div class="card" style="margin-top:12px">
        <div class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="setting-row">
          <div><div class="setting-label">–°—Ç–∏–ª—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div><div class="setting-desc" id="styleDesc">iOS</div></div>
          <div class="toggle" id="styleToggle" onclick="toggleStyle()"><div class="toggle-knob"></div></div>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">–í–∏–±—Ä–∞—Ü–∏—è</div></div>
          <div class="toggle on" id="hapticToggle" onclick="toggleHaptic()"><div class="toggle-knob"></div></div>
        </div>
        <div class="setting-row">
          <div><div class="setting-label">–ó–≤—É–∫–∏</div></div>
          <div class="toggle on" id="soundToggle" onclick="toggleSound()"><div class="toggle-knob"></div></div>
        </div>
      </div>
      <button class="btn btn-primary" style="margin-top:8px" onclick="testPayment()">‚≠ê –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã (1‚≠ê ‚Üí –≤–æ–∑–≤—Ä–∞—Ç)</button>
      <button class="btn btn-dark" style="margin-top:8px" onclick="shareBot()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      <button class="btn btn-red" style="margin-top:8px" onclick="resetProgress()">üóë –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
      <div id="adminPanel"></div>
      <div style="height:100px"></div>
    </div>
  </div>

  <!-- Tab Bar -->
  <div class="tab-bar" id="tabBar">
    <div class="tab-item active" onclick="switchTab(0)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
      <span>–ö–ª–∏–∫–µ—Ä</span>
    </div>
    <div class="tab-item" onclick="switchTab(1)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 01-8 0"/></svg>
      <span>–ú–∞–≥–∞–∑–∏–Ω</span>
    </div>
    <div class="tab-item" onclick="switchTab(2)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
      <span>–ö–æ–ª–ª–µ–∫—Ü–∏—è</span>
    </div>
    <div class="tab-item" onclick="switchTab(3)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      <span>–ó–∞–¥–∞–Ω–∏—è</span>
    </div>
    <div class="tab-item" onclick="switchTab(4)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 10c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5z"/><path d="M20.5 10H19V8.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/><path d="M9.5 14c.83 0 1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5S8 21.33 8 20.5v-5c0-.83.67-1.5 1.5-1.5z"/><path d="M3.5 14H5v1.5c0 .83-.67 1.5-1.5 1.5S2 16.33 2 15.5 2.67 14 3.5 14z"/><path d="M14 14.5c0-.83.67-1.5 1.5-1.5h5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-5c-.83 0-1.5-.67-1.5-1.5z"/><path d="M15.5 19H14v1.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"/><path d="M10 9.5C10 10.33 9.33 11 8.5 11h-5C2.67 11 2 10.33 2 9.5S2.67 8 3.5 8h5c.83 0 1.5.67 1.5 1.5z"/><path d="M8.5 5H10V3.5C10 2.67 9.33 2 8.5 2S7 2.67 7 3.5 7.67 5 8.5 5z"/></svg>
      <span>–ë–æ–π</span>
    </div>
    <div class="tab-item" onclick="switchTab(5)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><path d="M3 6h.01"/><path d="M3 12h.01"/><path d="M3 18h.01"/></svg>
      <span>–¢–æ–ø</span>
    </div>
    <div class="tab-item" onclick="switchTab(6)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
    </div>
  </div>
</div>

<!-- Boss Overlay -->
<div class="boss-overlay" id="bossOverlay">
  <div style="font-size:14px;color:var(--text2)" id="bossName">–ë–æ—Å—Å</div>
  <div class="boss-sprite" id="bossSprite"></div>
  <div class="boss-hp"><div class="boss-hp-track"><div class="boss-hp-fill" id="bossHpFill" style="width:100%"></div></div></div>
  <div style="font-size:12px;color:var(--text2)"><span id="bossHpText">100/100</span> HP</div>
  <div class="boss-timer" id="bossTimer">30</div>
  <button class="boss-tap-btn" ontouchstart="bossHit(event)" onmousedown="bossHit(event)">
    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M14.5 17.5L3 6 6 3l11.5 11.5"/><path d="M13 19l6-6"/><path d="M16 16l4 4"/></svg>
  </button>
  <div style="font-size:11px;color:var(--text3);margin-top:12px">–¢–∞–ø–∞–π —á—Ç–æ–±—ã –±–∏—Ç—å!</div>
</div>

<!-- Duel Overlay -->
<div class="duel-overlay" id="duelOverlay">
  <div class="duel-timer" id="duelTimer">30</div>
  <div class="duel-vs">
    <div class="duel-player">
      <div class="duel-player-avatar" id="duelMyAvatar"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
      <div class="duel-player-name" id="duelMyName">–Ø</div>
      <div class="duel-player-taps" id="duelMyTaps">0</div>
    </div>
    <div style="font-size:24px;font-weight:900;color:var(--red)">VS</div>
    <div class="duel-player">
      <div class="duel-player-avatar" id="duelOppAvatar"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
      <div class="duel-player-name" id="duelOppName">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
      <div class="duel-player-taps" id="duelOppTaps">0</div>
    </div>
  </div>
  <button class="duel-tap-btn" ontouchstart="duelTap(event)" onmousedown="duelTap(event)">
    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
  </button>
  <div style="font-size:11px;color:var(--text3);margin-top:12px" id="duelStatus">–¢–∞–ø–∞–π –±—ã—Å—Ç—Ä–µ–µ!</div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="rouletteModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üé∞ –†—É–ª–µ—Ç–∫–∞ —É–¥–∞—á–∏</div>
    <div class="roulette-wrap">
      <div class="roulette-pointer">‚ñº</div>
      <canvas class="roulette-canvas" id="rouletteCanvas" width="520" height="520"></canvas>
    </div>
    <button class="btn btn-primary" style="margin-top:16px" id="rouletteBtn" onclick="spinRoulette()">–ö—Ä—É—Ç–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ!</button>
    <button class="btn btn-dark" style="margin-top:8px" onclick="closeModal('rouletteModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div class="modal-overlay" id="codeModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üîë –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥</div>
    <div class="code-input-wrap">
      <input class="code-input" id="codeInput" placeholder="–í–≤–µ–¥–∏ –∫–æ–¥..." autocomplete="off">
      <button class="btn btn-primary" style="width:auto;padding:12px 20px" onclick="submitCode()">‚Üí</button>
    </div>
    <button class="btn btn-dark" style="margin-top:12px" onclick="closeModal('codeModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- Banned Screen -->
<div class="banned-screen" id="bannedScreen">
  <div class="banned-icon">üö´</div>
  <div class="banned-title">–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã</div>
  <div class="banned-text">–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É @Vriskas_official</div>
</div>

<!-- Cheater Screen -->
<div class="cheater-screen" id="cheaterScreen">
  <div style="font-size:64px;margin-bottom:16px">üö´</div>
  <div style="font-size:24px;font-weight:900;color:var(--red);margin-bottom:8px">–ß–∏—Ç–∞–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω!</div>
  <div style="font-size:14px;color:var(--text2);text-align:center">–í—ã –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω—ã. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã.</div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ===== CONFIG =====
const BOT_TOKEN='8328808800:AAGXn9OCZNgo79kcWZhnZgx4m1DEiUeVhdc';
const SAVE_KEY='vriskas_v25';
const ADMIN_USERNAME='Vriskas_official';

// Firebase
firebase.initializeApp({
  apiKey:"AIzaSyCnFnvWy-gklDVNqWMOFdx9B9uJi0Lo-JU",
  authDomain:"telegrambotvriskas.firebaseapp.com",
  databaseURL:"https://telegrambotvriskas-default-rtdb.firebaseio.com",
  projectId:"telegrambotvriskas",
  storageBucket:"telegrambotvriskas.firebasestorage.app",
  messagingSenderId:"878769255530",
  appId:"1:878769255530:web:461ef3885f859f039d8613"
});
const db=firebase.database();
let dbConnected=false;

// Telegram
const tg=window.Telegram&&window.Telegram.WebApp?Telegram.WebApp:null;
if(tg){tg.ready();tg.expand();tg.setHeaderColor&&tg.setHeaderColor('#000000')}
const tgUser=tg&&tg.initDataUnsafe&&tg.initDataUnsafe.user?tg.initDataUnsafe.user:null;
const isDark=!tg||!tg.colorScheme||tg.colorScheme==='dark';
if(!isDark)document.documentElement.classList.add('theme-light');

// ===== LEVELS =====
const LEVELS=[
  {n:'–ù–æ–≤–∏—á–æ–∫',xp:0,r:0,rs:0},{n:'–£—á–µ–Ω–∏–∫',xp:100,r:200,rs:1},{n:'–õ—é–±–∏—Ç–µ–ª—å',xp:500,r:500,rs:2},
  {n:'–ö–ª–∏–∫–µ—Ä',xp:2000,r:1000,rs:3},{n:'–¢–∞–ø–µ—Ä',xp:5000,r:2000,rs:5},{n:'–ú–∞—Å—Ç–µ—Ä',xp:15000,r:5000,rs:8},
  {n:'–≠–∫—Å–ø–µ—Ä—Ç',xp:40000,r:10000,rs:10},{n:'–ì—É—Ä—É',xp:100000,r:20000,rs:15},{n:'–õ–µ–≥–µ–Ω–¥–∞',xp:250000,r:50000,rs:20},
  {n:'–¢–∏—Ç–∞–Ω',xp:500000,r:100000,rs:30},{n:'–ë–æ–≥ –∫–ª–∏–∫–æ–≤',xp:1000000,r:200000,rs:50},{n:'–î–µ–º–∏—É—Ä–≥',xp:2500000,r:500000,rs:75},
  {n:'–°–æ–∑–¥–∞—Ç–µ–ª—å',xp:5000000,r:1000000,rs:100},{n:'–í–µ—á–Ω–æ—Å—Ç—å',xp:10000000,r:2000000,rs:150},
  {n:'–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å',xp:25000000,r:5000000,rs:200},{n:'–û–º–µ–≥–∞',xp:50000000,r:10000000,rs:300},
  {n:'–ê–±—Å–æ–ª—é—Ç',xp:100000000,r:25000000,rs:500},{n:'–¢—Ä–∞–Ω—Å—Ü–µ–Ω–¥–µ–Ω—Ç',xp:250000000,r:50000000,rs:750},
  {n:'Vriskas',xp:500000000,r:100000000,rs:1000}
];

// ===== BOSSES =====
const BOSSES=[
  {n:'–°–ª–∞–π–º',hp:50,time:30,reward:500,stars:1,svg:'<circle cx="50" cy="55" r="35" fill="#4ade80"/><ellipse cx="40" cy="48" rx="5" ry="7" fill="#fff"/><ellipse cx="60" cy="48" rx="5" ry="7" fill="#fff"/><circle cx="40" cy="50" r="3" fill="#000"/><circle cx="60" cy="50" r="3" fill="#000"/>'},
  {n:'–ì–æ–±–ª–∏–Ω',hp:200,time:30,reward:2000,stars:2,svg:'<circle cx="50" cy="50" r="30" fill="#22c55e"/><path d="M30 35 L20 20 L35 30Z" fill="#22c55e"/><path d="M70 35 L80 20 L65 30Z" fill="#22c55e"/><circle cx="40" cy="45" r="4" fill="#fff"/><circle cx="60" cy="45" r="4" fill="#fff"/><circle cx="40" cy="46" r="2" fill="red"/><circle cx="60" cy="46" r="2" fill="red"/><path d="M38 60 Q50 70 62 60" stroke="#000" stroke-width="2" fill="none"/>'},
  {n:'–°–∫–µ–ª–µ—Ç',hp:500,time:30,reward:5000,stars:3,svg:'<circle cx="50" cy="40" r="25" fill="#e5e5e5" stroke="#999" stroke-width="2"/><rect x="45" y="65" width="10" height="20" fill="#e5e5e5" rx="2"/><ellipse cx="42" cy="38" rx="6" ry="8" fill="#333"/><ellipse cx="58" cy="38" rx="6" ry="8" fill="#333"/><path d="M40 52 H60" stroke="#333" stroke-width="2"/><line x1="45" y1="52" x2="45" y2="48" stroke="#333" stroke-width="1.5"/><line x1="55" y1="52" x2="55" y2="48" stroke="#333" stroke-width="1.5"/>'},
  {n:'–û–≥–Ω–µ–Ω–Ω—ã–π –ú–∞–≥',hp:1500,time:30,reward:15000,stars:5,svg:'<circle cx="50" cy="50" r="28" fill="#dc2626"/><path d="M35 25 Q50 5 65 25 Q55 20 50 30 Q45 20 35 25Z" fill="#f97316"/><path d="M30 20 Q50 -5 70 20 Q55 10 50 25 Q45 10 30 20Z" fill="#fbbf24"/><circle cx="42" cy="48" r="4" fill="#fbbf24"/><circle cx="58" cy="48" r="4" fill="#fbbf24"/><path d="M40 60 Q50 68 60 60" stroke="#fbbf24" stroke-width="2" fill="none"/>'},
  {n:'–õ–µ–¥—è–Ω–æ–π –ì–æ–ª–µ–º',hp:4000,time:30,reward:40000,stars:8,svg:'<rect x="30" y="25" width="40" height="50" rx="8" fill="#93c5fd" stroke="#60a5fa" stroke-width="3"/><rect x="25" y="40" width="15" height="8" rx="4" fill="#93c5fd"/><rect x="60" y="40" width="15" height="8" rx="4" fill="#93c5fd"/><circle cx="42" cy="42" r="5" fill="#1e40af"/><circle cx="58" cy="42" r="5" fill="#1e40af"/><path d="M40 55 H60" stroke="#1e40af" stroke-width="3"/>'},
  {n:'–î—Ä–∞–∫–æ–Ω',hp:10000,time:35,reward:100000,stars:15,svg:'<ellipse cx="50" cy="50" rx="30" ry="25" fill="#dc2626"/><path d="M20 40 L10 25 L25 35Z" fill="#b91c1c"/><path d="M80 40 L90 25 L75 35Z" fill="#b91c1c"/><path d="M30 30 L25 15 Q50 20 50 30Z" fill="#991b1b"/><path d="M70 30 L75 15 Q50 20 50 30Z" fill="#991b1b"/><circle cx="40" cy="45" r="5" fill="#fbbf24"/><circle cx="60" cy="45" r="5" fill="#fbbf24"/><circle cx="40" cy="46" r="2" fill="#000"/><circle cx="60" cy="46" r="2" fill="#000"/><path d="M42 60 L50 65 L58 60" stroke="#fbbf24" stroke-width="2" fill="none"/>'},
  {n:'–¢–µ–Ω–µ–≤–æ–π –õ–æ—Ä–¥',hp:30000,time:35,reward:300000,stars:25,svg:'<circle cx="50" cy="50" r="30" fill="#1a1a2e"/><circle cx="50" cy="50" r="25" fill="#16213e"/><circle cx="42" cy="45" r="6" fill="#e94560"/><circle cx="58" cy="45" r="6" fill="#e94560"/><circle cx="42" cy="45" r="3" fill="#fff"/><circle cx="58" cy="45" r="3" fill="#fff"/><path d="M25 30 L35 40" stroke="#e94560" stroke-width="3"/><path d="M75 30 L65 40" stroke="#e94560" stroke-width="3"/>'},
  {n:'–î—Ä–µ–≤–Ω–∏–π –¢–∏—Ç–∞–Ω',hp:80000,time:40,reward:800000,stars:40,svg:'<rect x="25" y="20" width="50" height="60" rx="10" fill="#92400e"/><rect x="20" y="35" width="20" height="12" rx="6" fill="#92400e"/><rect x="60" y="35" width="20" height="12" rx="6" fill="#92400e"/><circle cx="40" cy="40" r="7" fill="#fbbf24"/><circle cx="60" cy="40" r="7" fill="#fbbf24"/><circle cx="40" cy="41" r="3" fill="#000"/><circle cx="60" cy="41" r="3" fill="#000"/><path d="M38 58 Q50 66 62 58" stroke="#000" stroke-width="3" fill="none"/>'},
  {n:'–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å –ë–µ–∑–¥–Ω—ã',hp:200000,time:40,reward:2000000,stars:75,svg:'<circle cx="50" cy="50" r="35" fill="#4a0072"/><circle cx="50" cy="50" r="28" fill="#7b00b4"/><path d="M30 30 L20 15" stroke="#c084fc" stroke-width="3"/><path d="M70 30 L80 15" stroke="#c084fc" stroke-width="3"/><path d="M50 20 L50 5" stroke="#c084fc" stroke-width="3"/><circle cx="42" cy="45" r="6" fill="#f0abfc"/><circle cx="58" cy="45" r="6" fill="#f0abfc"/><circle cx="42" cy="46" r="3" fill="#000"/><circle cx="58" cy="46" r="3" fill="#000"/><path d="M35 60 Q50 72 65 60" stroke="#f0abfc" stroke-width="2" fill="none"/>'},
  {n:'–ë–æ–≥ –í—Å–µ–ª–µ–Ω–Ω–æ–π',hp:500000,time:45,reward:5000000,stars:150,svg:'<circle cx="50" cy="50" r="35" fill="url(#godGrad)"/><defs><radialGradient id="godGrad"><stop offset="0%" stop-color="#ffd700"/><stop offset="100%" stop-color="#ff4500"/></radialGradient></defs><circle cx="42" cy="42" r="7" fill="#fff"/><circle cx="58" cy="42" r="7" fill="#fff"/><circle cx="42" cy="43" r="3" fill="#000"/><circle cx="58" cy="43" r="3" fill="#000"/><path d="M30 25 L22 10" stroke="#ffd700" stroke-width="3"/><path d="M70 25 L78 10" stroke="#ffd700" stroke-width="3"/><path d="M50 18 L50 3" stroke="#ffd700" stroke-width="3"/><path d="M35 20 L28 8" stroke="#ffd700" stroke-width="2"/><path d="M65 20 L72 8" stroke="#ffd700" stroke-width="2"/><path d="M38 62 Q50 72 62 62" stroke="#fff" stroke-width="2" fill="none"/>'}
];

// ===== SKINS =====
const SKINS=[
  {id:'classic',n:'–ö–ª–∞—Å—Å–∏–∫–∞',price:0,bonus:{},svg:'<circle cx="50" cy="50" r="45" fill="#ffd700" stroke="#c87800" stroke-width="3"/><text x="50" y="58" text-anchor="middle" font-size="36" font-weight="bold" fill="#8B6914">V</text>'},
  {id:'ruby',n:'–†—É–±–∏–Ω',price:1000,bonus:{perTap:2},svg:'<circle cx="50" cy="50" r="45" fill="#ef4444" stroke="#991b1b" stroke-width="3"/><polygon points="50,20 65,45 58,45 68,75 50,55 55,55 35,75 42,45 35,45" fill="#fca5a5"/>'},
  {id:'sapphire',n:'–°–∞–ø—Ñ–∏—Ä',price:2000,bonus:{cps:3},svg:'<circle cx="50" cy="50" r="45" fill="#3b82f6" stroke="#1e40af" stroke-width="3"/><polygon points="50,15 75,50 50,85 25,50" fill="#93c5fd" stroke="#60a5fa" stroke-width="2"/>'},
  {id:'emerald',n:'–ò–∑—É–º—Ä—É–¥',price:3000,bonus:{regen:3},svg:'<circle cx="50" cy="50" r="45" fill="#22c55e" stroke="#15803d" stroke-width="3"/><polygon points="50,18 72,35 72,65 50,82 28,65 28,35" fill="#86efac" stroke="#4ade80" stroke-width="2"/>'},
  {id:'diamond',n:'–ê–ª–º–∞–∑',price:8000,bonus:{perTap:5,cps:2},svg:'<circle cx="50" cy="50" r="45" fill="#67e8f9" stroke="#0891b2" stroke-width="3"/><polygon points="30,40 50,20 70,40 62,65 38,65" fill="#fff" stroke="#22d3ee" stroke-width="2" opacity="0.9"/><line x1="50" y1="20" x2="50" y2="65" stroke="#22d3ee" stroke-width="1" opacity="0.5"/>'},
  {id:'fire',n:'–û–≥–æ–Ω—å',price:10000,bonus:{perTap:3,regen:2},svg:'<circle cx="50" cy="50" r="45" fill="#f97316" stroke="#c2410c" stroke-width="3"/><path d="M50 15 C55 30 70 35 65 55 C63 65 55 75 50 80 C45 75 37 65 35 55 C30 35 45 30 50 15Z" fill="#fbbf24"/><path d="M50 35 C53 42 60 45 58 55 C56 62 53 68 50 72 C47 68 44 62 42 55 C40 45 47 42 50 35Z" fill="#fef3c7"/>'},
  {id:'ice',n:'–õ—ë–¥',price:12000,bonus:{energy:200},svg:'<circle cx="50" cy="50" r="45" fill="#bae6fd" stroke="#0284c7" stroke-width="3"/><path d="M50 15 L50 85 M25 32 L75 68 M75 32 L25 68" stroke="#fff" stroke-width="3" opacity="0.6"/><circle cx="50" cy="50" r="12" fill="#e0f2fe" stroke="#38bdf8" stroke-width="2"/>'},
  {id:'galaxy',n:'–ì–∞–ª–∞–∫—Ç–∏–∫–∞',price:20000,bonus:{cps:5,perTap:3},svg:'<circle cx="50" cy="50" r="45" fill="#1e1b4b" stroke="#4338ca" stroke-width="3"/><circle cx="35" cy="35" r="2" fill="#fff"/><circle cx="65" cy="30" r="1.5" fill="#fff"/><circle cx="55" cy="70" r="2" fill="#fff"/><circle cx="25" cy="60" r="1" fill="#fff"/><circle cx="70" cy="55" r="1.5" fill="#fff"/><circle cx="45" cy="45" r="1" fill="#fbbf24"/><ellipse cx="50" cy="50" rx="30" ry="10" fill="none" stroke="#818cf8" stroke-width="1.5" transform="rotate(-20 50 50)" opacity="0.5"/>'},
  {id:'toxic',n:'–¢–æ–∫—Å–∏–∫',price:25000,bonus:{perTap:8},svg:'<circle cx="50" cy="50" r="45" fill="#84cc16" stroke="#4d7c0f" stroke-width="3"/><circle cx="40" cy="42" r="8" fill="#000"/><circle cx="60" cy="42" r="8" fill="#000"/><circle cx="40" cy="42" r="4" fill="#bef264"/><circle cx="60" cy="42" r="4" fill="#bef264"/><path d="M35 65 Q50 75 65 65" stroke="#000" stroke-width="3" fill="none"/>'},
  {id:'skull',n:'–ß–µ—Ä–µ–ø',price:40000,bonus:{perTap:5,cps:5},svg:'<circle cx="50" cy="50" r="45" fill="#1f2937" stroke="#4b5563" stroke-width="3"/><ellipse cx="50" cy="42" rx="25" ry="28" fill="#e5e7eb"/><ellipse cx="40" cy="38" rx="7" ry="9" fill="#111827"/><ellipse cx="60" cy="38" rx="7" ry="9" fill="#111827"/><path d="M42 58 L46 55 L50 58 L54 55 L58 58" stroke="#111827" stroke-width="2.5" fill="none"/>'},
  {id:'rainbow',n:'–†–∞–¥—É–≥–∞',price:50000,bonus:{perTap:4,cps:4,regen:2},svg:'<circle cx="50" cy="50" r="45" fill="url(#rg1)"/><defs><linearGradient id="rg1" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ef4444"/><stop offset="25%" stop-color="#eab308"/><stop offset="50%" stop-color="#22c55e"/><stop offset="75%" stop-color="#3b82f6"/><stop offset="100%" stop-color="#a855f7"/></linearGradient></defs><text x="50" y="58" text-anchor="middle" font-size="36" font-weight="bold" fill="#fff">V</text>'},
  {id:'neon',n:'–ù–µ–æ–Ω',price:65000,bonus:{cps:10},svg:'<circle cx="50" cy="50" r="45" fill="#0f0f0f" stroke="#00ff88" stroke-width="2"/><circle cx="50" cy="50" r="38" fill="none" stroke="#00ff88" stroke-width="1" opacity="0.3"/><circle cx="50" cy="50" r="30" fill="none" stroke="#00ffff" stroke-width="1" opacity="0.3"/><text x="50" y="58" text-anchor="middle" font-size="36" font-weight="bold" fill="#00ff88">V</text>'},
  {id:'gold',n:'–ó–æ–ª–æ—Ç–æ–π',price:100000,bonus:{perTap:10,cps:8,energy:500},svg:'<circle cx="50" cy="50" r="45" fill="url(#gg1)"/><defs><radialGradient id="gg1"><stop offset="0%" stop-color="#fef3c7"/><stop offset="50%" stop-color="#fbbf24"/><stop offset="100%" stop-color="#b45309"/></radialGradient></defs><circle cx="50" cy="50" r="30" fill="none" stroke="#fef3c7" stroke-width="2" opacity="0.5"/><text x="50" y="58" text-anchor="middle" font-size="32" font-weight="bold" fill="#78350f">‚ôõ</text>'},
  {id:'plasma',n:'–ü–ª–∞–∑–º–∞',price:150000,bonus:{perTap:12,cps:10,regen:5},svg:'<circle cx="50" cy="50" r="45" fill="#7c3aed" stroke="#5b21b6" stroke-width="3"/><circle cx="50" cy="50" r="30" fill="none" stroke="#c084fc" stroke-width="2" opacity="0.4"/><circle cx="50" cy="50" r="20" fill="none" stroke="#e9d5ff" stroke-width="1.5" opacity="0.3"/><circle cx="50" cy="50" r="10" fill="#e9d5ff" opacity="0.3"/><path d="M50 20 Q65 35 50 50 Q35 65 50 80" stroke="#c084fc" stroke-width="2" fill="none"/>'},
  {id:'void',n:'–ë–µ–∑–¥–Ω–∞',price:200000,bonus:{perTap:15,cps:15,regen:5,energy:1000},svg:'<circle cx="50" cy="50" r="45" fill="#030712"/><circle cx="50" cy="50" r="35" fill="url(#vg1)"/><defs><radialGradient id="vg1"><stop offset="0%" stop-color="#312e81"/><stop offset="100%" stop-color="#030712"/></radialGradient></defs><circle cx="50" cy="50" r="15" fill="#1e1b4b"/><circle cx="50" cy="50" r="8" fill="#000"/><circle cx="35" cy="35" r="1" fill="#818cf8"/><circle cx="65" cy="65" r="1" fill="#818cf8"/><circle cx="60" cy="35" r="0.8" fill="#c084fc"/><circle cx="40" cy="65" r="0.8" fill="#c084fc"/>'},
  {id:'cyber',n:'–ö–∏–±–µ—Ä',price:300000,bonus:{perTap:20,cps:20,regen:8,energy:1500},svg:'<circle cx="50" cy="50" r="45" fill="#042f2e" stroke="#14b8a6" stroke-width="2"/><line x1="20" y1="30" x2="80" y2="30" stroke="#14b8a6" stroke-width="1" opacity="0.3"/><line x1="20" y1="50" x2="80" y2="50" stroke="#14b8a6" stroke-width="1" opacity="0.3"/><line x1="20" y1="70" x2="80" y2="70" stroke="#14b8a6" stroke-width="1" opacity="0.3"/><line x1="30" y1="20" x2="30" y2="80" stroke="#14b8a6" stroke-width="1" opacity="0.3"/><line x1="50" y1="20" x2="50" y2="80" stroke="#14b8a6" stroke-width="1" opacity="0.3"/><line x1="70" y1="20" x2="70" y2="80" stroke="#14b8a6" stroke-width="1" opacity="0.3"/><text x="50" y="56" text-anchor="middle" font-size="28" font-weight="bold" fill="#5eead4">01</text>'}
];

// ===== PETS =====
const PETS=[
  {id:'cat',n:'–ö–æ—Ç',price:2000,bonus:{perTap:1,cps:1},icon:'üê±'},
  {id:'dog',n:'–°–æ–±–∞–∫–∞',price:5000,bonus:{perTap:2,cps:2},icon:'üê∂'},
  {id:'dragon_pet',n:'–î—Ä–∞–∫–æ–Ω—á–∏–∫',price:15000,bonus:{perTap:5,cps:5},icon:'üê≤'},
  {id:'phoenix',n:'–§–µ–Ω–∏–∫—Å',price:50000,bonus:{perTap:8,cps:10},icon:'ü¶Ö'},
  {id:'unicorn',n:'–ï–¥–∏–Ω–æ—Ä–æ–≥',price:100000,bonus:{perTap:12,cps:15},icon:'ü¶Ñ'},
  {id:'robot',n:'–†–æ–±–æ—Ç',price:250000,bonus:{perTap:20,cps:25},icon:'ü§ñ'},
  {id:'alien',n:'–ò–Ω–æ–ø–ª–∞–Ω–µ—Ç—è–Ω–∏–Ω',price:500000,bonus:{perTap:30,cps:40},icon:'üëΩ'},
  {id:'god_pet',n:'–ë–æ–∂–µ—Å—Ç–≤–æ',price:1000000,bonus:{perTap:50,cps:60},icon:'üëë'}
];

// ===== ARTIFACTS =====
const ARTIFACTS=[
  {id:'crown',n:'–ö–æ—Ä–æ–Ω–∞ –º—É–¥—Ä–æ—Å—Ç–∏',price:10000,desc:'x1.5 XP –∑–∞ —Ç–∞–ø—ã',icon:'üëë'},
  {id:'ring',n:'–ö–æ–ª—å—Ü–æ —Å–∏–ª—ã',price:25000,desc:'+20% –∫ —Ç–∞–ø—É',icon:'üíç'},
  {id:'amulet',n:'–ê–º—É–ª–µ—Ç —É–¥–∞—á–∏',price:50000,desc:'+50% –Ω–∞–≥—Ä–∞–¥—ã',icon:'üîÆ'},
  {id:'sword',n:'–ú–µ—á –≥–µ—Ä–æ—è',price:75000,desc:'+50% —É—Ä–æ–Ω –±–æ—Å—Å–∞–º',icon:'‚öîÔ∏è'},
  {id:'book',n:'–ö–Ω–∏–≥–∞ –∑–Ω–∞–Ω–∏–π',price:100000,desc:'x2 XP',icon:'üìñ'},
  {id:'stone',n:'–ö–∞–º–µ–Ω—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏',price:200000,desc:'+100% –∫–æ –≤—Å–µ–º—É',icon:'üíé'},
  {id:'clock',n:'–ß–∞—Å—ã –≤—Ä–µ–º–µ–Ω–∏',price:300000,desc:'x2 –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥',icon:'‚è∞'},
  {id:'heart',n:'–°–µ—Ä–¥—Ü–µ —Ç–∏—Ç–∞–Ω–∞',price:500000,desc:'+1000 —ç–Ω–µ—Ä–≥–∏–∏',icon:'‚ù§Ô∏è'}
];

// ===== WORLDS =====
const WORLDS=[
  {id:'earth',n:'–ó–µ–º–ª—è',lvl:1,mult:1,icon:'üåç',desc:'–ù–∞—á–∞–ª—å–Ω—ã–π –º–∏—Ä'},
  {id:'moon',n:'–õ—É–Ω–∞',lvl:5,mult:2,icon:'üåô',desc:'x2 –º–æ–Ω–µ—Ç—ã'},
  {id:'mars',n:'–ú–∞—Ä—Å',lvl:10,mult:3,icon:'üî¥',desc:'x3 –º–æ–Ω–µ—Ç—ã'},
  {id:'jupiter',n:'–Æ–ø–∏—Ç–µ—Ä',lvl:15,mult:5,icon:'üü†',desc:'x5 –º–æ–Ω–µ—Ç—ã'},
  {id:'nebula',n:'–¢—É–º–∞–Ω–Ω–æ—Å—Ç—å',lvl:20,mult:8,icon:'üåå',desc:'x8 –º–æ–Ω–µ—Ç—ã'},
  {id:'galaxy_w',n:'–ì–∞–ª–∞–∫—Ç–∏–∫–∞',lvl:25,mult:10,icon:'‚ú®',desc:'x10 –º–æ–Ω–µ—Ç—ã'}
];

// ===== SHOP UPGRADES =====
const UPGRADES=[
  {id:'finger1',n:'–ö—Ä–µ–ø–∫–∏–π –ø–∞–ª–µ—Ü',desc:'+1 –∑–∞ —Ç–∞–ø',icon:'üëÜ',base:15,mult:1.6,eff:'perTap',val:1,max:50},
  {id:'finger2',n:'–ó–æ–ª–æ—Ç–æ–π –ø–∞–ª–µ—Ü',desc:'+3 –∑–∞ —Ç–∞–ø',icon:'‚úåÔ∏è',base:100,mult:1.7,eff:'perTap',val:3,max:30},
  {id:'finger3',n:'–ê–ª–º–∞–∑–Ω—ã–π –ø–∞–ª–µ—Ü',desc:'+10 –∑–∞ —Ç–∞–ø',icon:'üíé',base:1000,mult:1.8,eff:'perTap',val:10,max:20},
  {id:'battery',n:'–ë–∞—Ç–∞—Ä–µ–π–∫–∞',desc:'+50 —ç–Ω–µ—Ä–≥–∏–∏',icon:'üîã',base:50,mult:1.5,eff:'maxEnergy',val:50,max:50},
  {id:'battery2',n:'–ú–µ–≥–∞ –±–∞—Ç–∞—Ä–µ—è',desc:'+200 —ç–Ω–µ—Ä–≥–∏–∏',icon:'‚ö°',base:500,mult:1.6,eff:'maxEnergy',val:200,max:20},
  {id:'regen',n:'–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è',desc:'+1 —ç–Ω–µ—Ä–≥–∏–∏/—Å',icon:'üíö',base:80,mult:1.6,eff:'regen',val:1,max:30},
  {id:'regen2',n:'–°—É–ø–µ—Ä —Ä–µ–≥–µ–Ω',desc:'+3 —ç–Ω–µ—Ä–≥–∏–∏/—Å',icon:'üíñ',base:800,mult:1.7,eff:'regen',val:3,max:15},
  {id:'auto1',n:'–ê–≤—Ç–æ-–∫–ª–∏–∫–µ—Ä',desc:'+1 –º–æ–Ω–µ—Ç–∞/—Å',icon:'ü§ñ',base:100,mult:1.7,eff:'cps',val:1,max:30},
  {id:'auto2',n:'–ú–µ–≥–∞-–±–æ—Ç',desc:'+5 –º–æ–Ω–µ—Ç/—Å',icon:'ü¶æ',base:800,mult:1.8,eff:'cps',val:5,max:20},
  {id:'auto3',n:'–§–∞–±—Ä–∏–∫–∞',desc:'+20 –º–æ–Ω–µ—Ç/—Å',icon:'üè≠',base:5000,mult:1.9,eff:'cps',val:20,max:15},
  {id:'auto4',n:'–ö–æ—Ä–ø–æ—Ä–∞—Ü–∏—è',desc:'+50 –º–æ–Ω–µ—Ç/—Å',icon:'üè¢',base:25000,mult:2.0,eff:'cps',val:50,max:10},
  {id:'mult',n:'–ú–Ω–æ–∂–∏—Ç–µ–ª—å',desc:'+10% –∫ —Ç–∞–ø—É',icon:'‚úñÔ∏è',base:2000,mult:2.0,eff:'tapMult',val:0.1,max:10},
  {id:'crit',n:'–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–¥–∞—Ä',desc:'–®–∞–Ω—Å x5 —Ç–∞–ø',icon:'üí•',base:3000,mult:2.0,eff:'crit',val:0.03,max:10},
  {id:'luck',n:'–£–¥–∞—á–∞',desc:'+5% –∫ –∑–æ–ª–æ—Ç—ã–º',icon:'üçÄ',base:1500,mult:1.8,eff:'luck',val:0.05,max:10},
  {id:'magnet',n:'–ú–∞–≥–Ω–∏—Ç',desc:'+15% –∫–æ –≤—Å–µ–º—É',icon:'üß≤',base:10000,mult:2.2,eff:'magnet',val:0.15,max:5},
  {id:'stargen',n:'–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä ‚≠ê',desc:'+1‚≠ê/–º–∏–Ω',icon:'‚≠ê',base:50000,mult:2.5,eff:'starGen',val:1,max:5},
];

// Special items
const SPECIALS=[
  {id:'refill',n:'–ü–æ–ª–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è',desc:'–ó–∞–ø–æ–ª–Ω–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é',icon:'‚ö°',price:5000,type:'refill'},
  {id:'x2_60',n:'x2 –º–æ–Ω–µ—Ç—ã 60—Å',desc:'–î–≤–æ–π–Ω—ã–µ –º–æ–Ω–µ—Ç—ã –Ω–∞ –º–∏–Ω—É—Ç—É',icon:'üí∞',price:25000,type:'x2'},
  {id:'megacombo',n:'–ú–µ–≥–∞ –∫–æ–º–±–æ x50',desc:'–ü–æ–ª—É—á–∏—Ç—å x50 –∫–æ–º–±–æ',icon:'üî•',price:50000,type:'combo'},
  {id:'elite_boss',n:'–≠–ª–∏—Ç–Ω—ã–π –±–æ—Å—Å',desc:'–ë–æ—Å—Å —Å x3 –Ω–∞–≥—Ä–∞–¥–æ–π',icon:'üëπ',price:30000,type:'elite_boss'},
  {id:'time_skip',n:'–°–∫–∞—á–æ–∫ –≤—Ä–µ–º–µ–Ω–∏',desc:'2 —á–∞—Å–∞ –ø–∞—Å—Å–∏–≤–∞ —Å—Ä–∞–∑—É',icon:'‚è∞',price:100000,type:'timeskip'},
  {id:'buy_stars',n:'–ö—É–ø–∏—Ç—å 10‚≠ê',desc:'–ó–∞ –º–æ–Ω–µ—Ç—ã',icon:'‚≠ê',price:50000,type:'buystars'},
  {id:'star_boost',n:'–ó–≤—ë–∑–¥–Ω—ã–π –±—É—Å—Ç',desc:'+5 –∫ —Ç–∞–ø—É –Ω–∞–≤—Å–µ–≥–¥–∞',icon:'üåü',costStars:20,type:'starboost'},
  {id:'coin_pack',n:'–ü–∞–∫–µ—Ç –º–æ–Ω–µ—Ç',desc:'+5000 –º–æ–Ω–µ—Ç',icon:'üí∞',price:2000,type:'coinpack'},
];

// Stars purchases
const STAR_ITEMS=[
  {id:'s_megatap',n:'–ú–µ–≥–∞ –¢–∞–ø',desc:'+10 –∫ —Ç–∞–ø—É –Ω–∞–≤—Å–µ–≥–¥–∞',stars:50,eff:'perTap',val:10},
  {id:'s_energy',n:'–ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è',desc:'+5000 —ç–Ω–µ—Ä–≥–∏–∏',stars:75,eff:'maxEnergy',val:5000},
  {id:'s_ultrabot',n:'–£–ª—å—Ç—Ä–∞-–±–æ—Ç',desc:'+50 –º–æ–Ω–µ—Ç/—Å',stars:100,eff:'cps',val:50},
  {id:'s_megaregen',n:'–ú–µ–≥–∞ —Ä–µ–≥–µ–Ω',desc:'+20 —ç–Ω–µ—Ä–≥–∏–∏/—Å',stars:60,eff:'regen',val:20},
  {id:'s_legend',n:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Ç–∞–ø',desc:'+50 –∫ —Ç–∞–ø—É',stars:150,eff:'perTap',val:50},
  {id:'s_pack',n:'–°—Ç–∞—Ä—Ç–æ–≤—ã–π –ø–∞–∫',desc:'+10000 –º–æ–Ω–µ—Ç',stars:30,eff:'coins',val:10000},
  {id:'s_stars100',n:'+100 –∏–≥—Ä–æ–≤—ã—Ö ‚≠ê',desc:'–ó–≤—ë–∑–¥—ã –≤ –∏–≥—Ä–µ',stars:25,eff:'gameStars',val:100},
];

// ===== SECRET CODES =====
const CODES={
  'VRISKAS2024':{coins:5000,stars:10,msg:'–ö–æ–¥ Vriskas!'},
  'FREESTARS':{stars:25,msg:'–ó–≤—ë–∑–¥–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫!'},
  'MEGABOOST':{coins:10000,msg:'–ú–µ–≥–∞ –±—É—Å—Ç!'},
  'CLICKERGOD':{coins:50000,stars:20,msg:'–¢—ã –±–æ–≥ –∫–ª–∏–∫–µ—Ä–∞!'},
  'ENERGY9999':{refill:true,msg:'–≠–Ω–µ—Ä–≥–∏—è –ø–æ–ª–Ω–∞—è!'},
  'LUCKY777':{coins:7777,stars:7,msg:'–°—á–∞—Å—Ç–ª–∏–≤–æ–µ —á–∏—Å–ª–æ!'},
  'BOSS':{boss:true,msg:'–ë–æ—Å—Å –≤—ã–∑–≤–∞–Ω!'},
  'MILLION':{coins:100000,msg:'–ú–∏–ª–ª–∏–æ–Ω–µ—Ä!'},
  'RAINBOW':{coins:25000,stars:15,msg:'–†–∞–¥—É–∂–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫!'},
  'SECRET':{coins:15000,stars:30,msg:'–°–µ–∫—Ä–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç!'},
};

// ===== ACHIEVEMENTS =====
const ACHIEVEMENTS=[
  // Taps
  {id:'tap1',n:'–ü–µ—Ä–≤—ã–π —Ç–∞–ø',d:'–°–¥–µ–ª–∞–π 1 —Ç–∞–ø',g:()=>S.totalTaps>=1,r:50},{id:'tap2',n:'–°–æ—Ç–Ω—è',d:'100 —Ç–∞–ø–æ–≤',g:()=>S.totalTaps>=100,r:200},
  {id:'tap3',n:'–¢—ã—Å—è—á–∞',d:'1,000 —Ç–∞–ø–æ–≤',g:()=>S.totalTaps>=1000,r:500},{id:'tap4',n:'10K —Ç–∞–ø–æ–≤',d:'10,000 —Ç–∞–ø–æ–≤',g:()=>S.totalTaps>=10000,r:2000},
  {id:'tap5',n:'100K —Ç–∞–ø–æ–≤',d:'100,000 —Ç–∞–ø–æ–≤',g:()=>S.totalTaps>=100000,r:10000},{id:'tap6',n:'–ú–∏–ª–ª–∏–æ–Ω —Ç–∞–ø–æ–≤',d:'1,000,000 —Ç–∞–ø–æ–≤',g:()=>S.totalTaps>=1000000,r:50000},
  {id:'tap7',n:'5M —Ç–∞–ø–æ–≤',d:'5,000,000 —Ç–∞–ø–æ–≤',g:()=>S.totalTaps>=5000000,r:200000},{id:'tap8',n:'10M —Ç–∞–ø–æ–≤',d:'10,000,000 —Ç–∞–ø–æ–≤',g:()=>S.totalTaps>=10000000,r:500000},
  // Coins
  {id:'coin1',n:'–ü–µ—Ä–≤–∞—è —Å–æ—Ç–Ω—è',d:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 100',g:()=>S.totalEarned>=100,r:50},{id:'coin2',n:'–¢—ã—Å—è—á–Ω–∏–∫',d:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 1,000',g:()=>S.totalEarned>=1000,r:200},
  {id:'coin3',n:'10K –∫–ª—É–±',d:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 10,000',g:()=>S.totalEarned>=10000,r:1000},{id:'coin4',n:'100K –∫–ª—É–±',d:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 100K',g:()=>S.totalEarned>=100000,r:5000},
  {id:'coin5',n:'–ú–∏–ª–ª–∏–æ–Ω–µ—Ä',d:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 1M',g:()=>S.totalEarned>=1000000,r:25000},{id:'coin6',n:'–ú—É–ª—å—Ç–∏–º–∏–ª–ª–∏–æ–Ω–µ—Ä',d:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 10M',g:()=>S.totalEarned>=10000000,r:100000},
  {id:'coin7',n:'–ú–∏–ª–ª–∏–∞—Ä–¥–µ—Ä',d:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 1B',g:()=>S.totalEarned>=1000000000,r:1000000},
  // Combo
  {id:'combo1',n:'–ö–æ–º–±–æ x2',d:'–î–æ—Å—Ç–∏–≥–Ω–∏ –∫–æ–º–±–æ x2',g:()=>S.maxCombo>=2,r:100},{id:'combo2',n:'–ö–æ–º–±–æ x5',d:'–ö–æ–º–±–æ x5',g:()=>S.maxCombo>=5,r:500},
  {id:'combo3',n:'–ö–æ–º–±–æ x10',d:'–ö–æ–º–±–æ x10',g:()=>S.maxCombo>=10,r:2000},{id:'combo4',n:'–ö–æ–º–±–æ x20',d:'–ö–æ–º–±–æ x20',g:()=>S.maxCombo>=20,r:10000},
  {id:'combo5',n:'–ö–æ–º–±–æ x50',d:'–ö–æ–º–±–æ x50',g:()=>S.maxCombo>=50,r:50000},
  // Boss
  {id:'boss1',n:'–£–±–∏–π—Ü–∞ —Å–ª–∞–π–º–∞',d:'–£–±–µ–π 1 –±–æ—Å—Å–∞',g:()=>S.bossKills>=1,r:500},{id:'boss2',n:'–û—Ö–æ—Ç–Ω–∏–∫',d:'–£–±–µ–π 5 –±–æ—Å—Å–æ–≤',g:()=>S.bossKills>=5,r:2000},
  {id:'boss3',n:'–ò—Å—Ç—Ä–µ–±–∏—Ç–µ–ª—å',d:'–£–±–µ–π 10 –±–æ—Å—Å–æ–≤',g:()=>S.bossKills>=10,r:5000},{id:'boss4',n:'–õ–µ–≥–µ–Ω–¥–∞ –∞—Ä–µ–Ω—ã',d:'–£–±–µ–π 25 –±–æ—Å—Å–æ–≤',g:()=>S.bossKills>=25,r:25000},
  {id:'boss5',n:'–ë–æ–≥ –≤–æ–π–Ω—ã',d:'–£–±–µ–π 50 –±–æ—Å—Å–æ–≤',g:()=>S.bossKills>=50,r:100000},
  // Duel
  {id:'duel1',n:'–ü–µ—Ä–≤–∞—è –ø–æ–±–µ–¥–∞',d:'–í—ã–∏–≥—Ä–∞–π –¥—É—ç–ª—å',g:()=>S.duelWins>=1,r:1000},{id:'duel2',n:'–ë–æ–µ—Ü',d:'5 –ø–æ–±–µ–¥',g:()=>S.duelWins>=5,r:5000},
  {id:'duel3',n:'–ß–µ–º–ø–∏–æ–Ω',d:'15 –ø–æ–±–µ–¥',g:()=>S.duelWins>=15,r:20000},{id:'duel4',n:'–ù–µ–ø–æ–±–µ–¥–∏–º—ã–π',d:'50 –ø–æ–±–µ–¥',g:()=>S.duelWins>=50,r:100000},
  // Level
  {id:'lvl1',n:'–£—Ä–æ–≤–µ–Ω—å 3',d:'–î–æ—Å—Ç–∏–≥–Ω–∏ —É—Ä.3',g:()=>getLevel()>=3,r:300},{id:'lvl2',n:'–£—Ä–æ–≤–µ–Ω—å 5',d:'–î–æ—Å—Ç–∏–≥–Ω–∏ —É—Ä.5',g:()=>getLevel()>=5,r:1000},
  {id:'lvl3',n:'–£—Ä–æ–≤–µ–Ω—å 10',d:'–î–æ—Å—Ç–∏–≥–Ω–∏ —É—Ä.10',g:()=>getLevel()>=10,r:5000},{id:'lvl4',n:'–£—Ä–æ–≤–µ–Ω—å 15',d:'–î–æ—Å—Ç–∏–≥–Ω–∏ —É—Ä.15',g:()=>getLevel()>=15,r:25000},
  {id:'lvl5',n:'–£—Ä–æ–≤–µ–Ω—å 19',d:'–î–æ—Å—Ç–∏–≥–Ω–∏ –º–∞–∫—Å',g:()=>getLevel()>=19,r:500000},
  // Stars
  {id:'star1',n:'–ü–µ—Ä–≤–∞—è –∑–≤–µ–∑–¥–∞',d:'–ü–æ–ª—É—á–∏ 1‚≠ê',g:()=>S.totalStarsEarned>=1,r:200},{id:'star2',n:'10 –∑–≤—ë–∑–¥',d:'–ü–æ–ª—É—á–∏ 10‚≠ê',g:()=>S.totalStarsEarned>=10,r:1000},
  {id:'star3',n:'50 –∑–≤—ë–∑–¥',d:'–ü–æ–ª—É—á–∏ 50‚≠ê',g:()=>S.totalStarsEarned>=50,r:5000},{id:'star4',n:'200 –∑–≤—ë–∑–¥',d:'–ü–æ–ª—É—á–∏ 200‚≠ê',g:()=>S.totalStarsEarned>=200,r:25000},
  // Skins
  {id:'skin1',n:'–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä',d:'–ö—É–ø–∏ 3 —Å–∫–∏–Ω–∞',g:()=>S.ownedSkins.length>=3,r:1000},{id:'skin2',n:'–ú–æ–¥–Ω–∏–∫',d:'–ö—É–ø–∏ 8 —Å–∫–∏–Ω–æ–≤',g:()=>S.ownedSkins.length>=8,r:10000},
  {id:'skin3',n:'–í—Å–µ —Å–∫–∏–Ω—ã',d:'–ö—É–ø–∏ –≤—Å–µ —Å–∫–∏–Ω—ã',g:()=>S.ownedSkins.length>=SKINS.length,r:100000},
  // Pets
  {id:'pet1',n:'–ü–∏—Ç–æ–º–µ—Ü!',d:'–ö—É–ø–∏ –ø–∏—Ç–æ–º—Ü–∞',g:()=>S.ownedPets.length>=1,r:500},{id:'pet2',n:'–ó–æ–æ–ø–∞—Ä–∫',d:'–ö—É–ø–∏ 4 –ø–∏—Ç–æ–º—Ü–∞',g:()=>S.ownedPets.length>=4,r:10000},
  // Artifacts
  {id:'art1',n:'–ê—Ä—Ç–µ—Ñ–∞–∫—Ç!',d:'–ö—É–ø–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç',g:()=>S.ownedArtifacts.length>=1,r:1000},{id:'art2',n:'–ö–æ–ª–ª–µ–∫—Ü–∏—è',d:'–ö—É–ø–∏ 4 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞',g:()=>S.ownedArtifacts.length>=4,r:20000},
  // Daily
  {id:'daily1',n:'3 –¥–Ω—è –ø–æ–¥—Ä—è–¥',d:'–î–µ–π–ª–∏–∫ 3 –¥–Ω—è',g:()=>S.dailyStreak>=3,r:500},{id:'daily2',n:'7 –¥–Ω–µ–π',d:'–î–µ–π–ª–∏–∫ 7 –¥–Ω–µ–π',g:()=>S.dailyStreak>=7,r:2000},
  {id:'daily3',n:'30 –¥–Ω–µ–π',d:'–î–µ–π–ª–∏–∫ 30 –¥–Ω–µ–π',g:()=>S.dailyStreak>=30,r:20000},
  // Golden
  {id:'gold1',n:'–ó–æ–ª–æ—Ç–æ–∏—Å–∫–∞—Ç–µ–ª—å',d:'–ü–æ–π–º–∞–π 10 –∑–æ–ª–æ—Ç—ã—Ö',g:()=>S.goldenCaught>=10,r:1000},{id:'gold2',n:'–ó–æ–ª–æ—Ç–æ–π –±–æ–≥',d:'–ü–æ–π–º–∞–π 50 –∑–æ–ª–æ—Ç—ã—Ö',g:()=>S.goldenCaught>=50,r:10000},
  // Codes
  {id:'code1',n:'–•–∞–∫–µ—Ä',d:'–í–≤–µ–¥–∏ 3 –∫–æ–¥–∞',g:()=>S.codesUsed>=3,r:1000},{id:'code2',n:'–í—Å–µ –∫–æ–¥—ã',d:'–í–≤–µ–¥–∏ 8 –∫–æ–¥–æ–≤',g:()=>S.codesUsed>=8,r:10000},
  // CPS
  {id:'cps1',n:'–ü–∞—Å—Å–∏–≤',d:'10 –º–æ–Ω–µ—Ç/—Å',g:()=>getCPS()>=10,r:2000},{id:'cps2',n:'–ú–∞–≥–Ω–∞—Ç',d:'100 –º–æ–Ω–µ—Ç/—Å',g:()=>getCPS()>=100,r:20000},
  // Upgrades
  {id:'upg1',n:'–ü—Ä–æ–∫–∞—á–∫–∞',d:'–ö—É–ø–∏ 10 –∞–ø–≥—Ä–µ–π–¥–æ–≤',g:()=>totalUpgrades()>=10,r:500},{id:'upg2',n:'–ú–∞–∫—Å –ø—Ä–æ–∫–∞—á–∫–∞',d:'50 –∞–ø–≥—Ä–µ–π–¥–æ–≤',g:()=>totalUpgrades()>=50,r:10000},
  // Energy
  {id:'nrg1',n:'–≠–Ω–µ—Ä–≥–∏—á–Ω—ã–π',d:'1000 –º–∞–∫—Å —ç–Ω–µ—Ä–≥–∏–∏',g:()=>getMaxEnergy()>=1000,r:1000},{id:'nrg2',n:'–ë–∞—Ç–∞—Ä–µ–π–∫–∞',d:'5000 –º–∞–∫—Å —ç–Ω–µ—Ä–≥–∏–∏',g:()=>getMaxEnergy()>=5000,r:10000},
  // Worlds
  {id:'w1',n:'–õ—É–Ω–∞—Ç–∏–∫',d:'–û—Ç–∫—Ä–æ–π –õ—É–Ω—É',g:()=>S.unlockedWorlds.includes('moon'),r:2000},{id:'w2',n:'–ì–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π',d:'–û—Ç–∫—Ä–æ–π –ì–∞–ª–∞–∫—Ç–∏–∫—É',g:()=>S.unlockedWorlds.includes('galaxy_w'),r:200000},
  // Roulette
  {id:'rou1',n:'–ò–≥—Ä–æ–∫',d:'–ö—Ä—É—Ç–Ω–∏ 5 —Ä–∞–∑',g:()=>S.rouletteSpins>=5,r:1000},{id:'rou2',n:'–ê–∑–∞—Ä—Ç–Ω—ã–π',d:'20 —Ä—É–ª–µ—Ç–æ–∫',g:()=>S.rouletteSpins>=20,r:5000},
  // Special
  {id:'billion',n:'–ú–ò–õ–õ–ò–ê–†–î–ï–†',d:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 1B –∏ –ø–æ—Ç—Ä–∞—Ç—å',g:()=>S.isBillionaire,r:0},
];

// ===== DAILY QUESTS =====
function getDailyQuests(){
  const seed=Math.floor(Date.now()/(24*60*60*1000));
  const all=[
    {n:'–°–¥–µ–ª–∞–π 200 —Ç–∞–ø–æ–≤',key:'taps',need:200,r:300,rs:1},
    {n:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 5,000',key:'earned',need:5000,r:500,rs:2},
    {n:'–î–æ—Å—Ç–∏–≥–Ω–∏ –∫–æ–º–±–æ x5',key:'combo',need:5,r:400,rs:1},
    {n:'–ö—É–ø–∏ 3 –∞–ø–≥—Ä–µ–π–¥–∞',key:'upgrades',need:3,r:600,rs:2},
    {n:'–£–±–µ–π –±–æ—Å—Å–∞',key:'boss',need:1,r:1000,rs:3},
    {n:'–ü–æ–π–º–∞–π 3 –∑–æ–ª–æ—Ç—ã—Ö',key:'golden',need:3,r:500,rs:2},
    {n:'–°–¥–µ–ª–∞–π 500 —Ç–∞–ø–æ–≤',key:'taps',need:500,r:600,rs:2},
    {n:'–ó–∞—Ä–∞–±–æ—Ç–∞–π 20,000',key:'earned',need:20000,r:2000,rs:5},
    {n:'–ö–æ–º–±–æ x10',key:'combo',need:10,r:1000,rs:3},
    {n:'–í—ã–∏–≥—Ä–∞–π –¥—É—ç–ª—å',key:'duelWin',need:1,r:2000,rs:5},
  ];
  const quests=[];
  for(let i=0;i<6;i++){quests.push(all[(seed*7+i*3)%all.length])}
  return quests;
}

// ===== STATE =====
let S={
  coins:0,totalEarned:0,totalTaps:0,energy:500,
  perTap:1,maxEnergy:500,regen:1,cps:0,
  tapMult:1,critChance:0,luckBonus:0,magnetBonus:0,starGenRate:0,
  upgrades:{},activeSkin:'classic',ownedSkins:['classic'],
  activePet:null,ownedPets:[],
  activeArtifacts:[],ownedArtifacts:[],
  activeWorld:'earth',unlockedWorlds:['earth'],
  gameStars:0,totalStarsEarned:0,
  bossKills:0,bossLevel:0,duelWins:0,duelLosses:0,
  dailyStreak:0,lastDaily:0,dailyQuestProg:{},dailyQuestClaimed:{},
  goldenCaught:0,codesUsed:0,usedCodes:[],
  rouletteSpins:0,lastRoulette:0,
  achievements:[],claimedLevelRewards:[],
  isBillionaire:false,
  combo:0,maxCombo:0,lastTapTime:0,
  x2Until:0,comboBoostUntil:0,noEnergyUntil:0,eventActive:null,eventUntil:0,
  lastSave:Date.now(),
  style:'ios',haptic:true,sound:true,
  starsPurchases:[],
  banned:false,
};

const SAVE_KEYS_TO_MIGRATE=['vriskas_v15','vriskas_v16','vriskas_v17','vriskas_v18','vriskas_v19','vriskas_v20','vriskas_v21','vriskas_v22','vriskas_v23','vriskas_v24'];

function migrate(){
  for(const k of SAVE_KEYS_TO_MIGRATE){
    const d=localStorage.getItem(k);
    if(d&&!localStorage.getItem(SAVE_KEY)){
      localStorage.setItem(SAVE_KEY,d);
      localStorage.removeItem(k);
    }
  }
}

function save(){
  antiCheat();
  S.lastSave=Date.now();
  localStorage.setItem(SAVE_KEY,JSON.stringify(S));
}

function load(){
  migrate();
  const d=localStorage.getItem(SAVE_KEY);
  if(d){
    try{
      const p=JSON.parse(d);
      const def={...S};
      S={...def,...p};
      if(!Array.isArray(S.ownedSkins))S.ownedSkins=['classic'];
      if(!S.ownedSkins.includes('classic'))S.ownedSkins.push('classic');
      if(!Array.isArray(S.ownedPets))S.ownedPets=[];
      if(!Array.isArray(S.ownedArtifacts))S.ownedArtifacts=[];
      if(!Array.isArray(S.activeArtifacts))S.activeArtifacts=[];
      if(!Array.isArray(S.unlockedWorlds))S.unlockedWorlds=['earth'];
      if(!S.unlockedWorlds.includes('earth'))S.unlockedWorlds.push('earth');
      if(!Array.isArray(S.achievements))S.achievements=[];
      if(!Array.isArray(S.claimedLevelRewards))S.claimedLevelRewards=[];
      if(!Array.isArray(S.usedCodes))S.usedCodes=[];
      if(!Array.isArray(S.starsPurchases))S.starsPurchases=[];
      if(typeof S.upgrades!=='object'||S.upgrades===null)S.upgrades={};
      // Calc derived stats
      recalcStats();
    }catch(e){console.error('Load error',e)}
  }
  // Offline earnings
  const elapsed=(Date.now()-S.lastSave)/1000;
  if(elapsed>60&&getCPS()>0){
    const maxOffline=4*3600;
    const secs=Math.min(elapsed,maxOffline);
    const earned=Math.floor(getCPS()*secs*0.5);
    if(earned>0){
      S.coins+=earned;S.totalEarned+=earned;
      setTimeout(()=>showToast('üí∞ –û—Ñ–ª–∞–π–Ω: +'+fmt(earned)+' –º–æ–Ω–µ—Ç –∑–∞ '+fmtTime(secs)),1000);
    }
  }
}

// ===== ANTI-CHEAT =====
const LIMITS={coins:50e9,totalEarned:50e9,totalTaps:100e6,perTap:100000,cps:50000,maxEnergy:50000,gameStars:100000};
function antiCheat(){
  for(const[k,lim]of Object.entries(LIMITS)){
    if(typeof S[k]==='number'&&S[k]>lim){
      cheaterDetected();return;
    }
  }
}
function cheaterDetected(){
  const uid=getUserId();
  localStorage.removeItem(SAVE_KEY);
  if(dbConnected&&uid)db.ref('vriskas_clicker/'+uid).remove();
  document.getElementById('cheaterScreen').classList.add('show');
}

// ===== STATS CALC =====
function recalcStats(){
  let pt=1,me=500,rg=1,cp=0,tm=1,cc=0,lb=0,mb=0,sg=0;
  // Upgrades
  for(const[uid,lvl]of Object.entries(S.upgrades)){
    const u=UPGRADES.find(x=>x.id===uid);
    if(!u)continue;
    if(u.eff==='perTap')pt+=u.val*lvl;
    if(u.eff==='maxEnergy')me+=u.val*lvl;
    if(u.eff==='regen')rg+=u.val*lvl;
    if(u.eff==='cps')cp+=u.val*lvl;
    if(u.eff==='tapMult')tm+=u.val*lvl;
    if(u.eff==='crit')cc+=u.val*lvl;
    if(u.eff==='luck')lb+=u.val*lvl;
    if(u.eff==='magnet')mb+=u.val*lvl;
    if(u.eff==='starGen')sg+=u.val*lvl;
  }
  // Skin bonus
  const skin=SKINS.find(s=>s.id===S.activeSkin);
  if(skin&&skin.bonus){
    if(skin.bonus.perTap)pt+=skin.bonus.perTap;
    if(skin.bonus.cps)cp+=skin.bonus.cps;
    if(skin.bonus.regen)rg+=skin.bonus.regen;
    if(skin.bonus.energy)me+=skin.bonus.energy;
  }
  // Pet bonus
  if(S.activePet){
    const pet=PETS.find(p=>p.id===S.activePet);
    if(pet&&pet.bonus){
      if(pet.bonus.perTap)pt+=pet.bonus.perTap;
      if(pet.bonus.cps)cp+=pet.bonus.cps;
    }
  }
  // Artifact bonuses
  for(const aid of S.activeArtifacts){
    const a=ARTIFACTS.find(x=>x.id===aid);
    if(!a)continue;
    if(aid==='ring')tm+=0.2;
    if(aid==='stone'){tm+=1.0;cp=Math.floor(cp*2)}
    if(aid==='clock')cp=Math.floor(cp*2);
    if(aid==='heart')me+=1000;
  }
  // World multiplier
  const world=WORLDS.find(w=>w.id===S.activeWorld);
  const worldMult=world?world.mult:1;
  
  S.perTap=Math.floor(pt*tm*worldMult);
  S.maxEnergy=me;
  S.regen=rg;
  S.cps=Math.floor(cp*worldMult);
  S.tapMult=tm;
  S.critChance=Math.min(cc,0.5);
  S.luckBonus=lb;
  S.magnetBonus=mb;
  S.starGenRate=sg;
  if(S.energy>S.maxEnergy)S.energy=S.maxEnergy;
}

function getCPS(){return S.cps}
function getMaxEnergy(){return S.maxEnergy}
function getLevel(){
  for(let i=LEVELS.length-1;i>=0;i--){
    if(S.totalEarned>=LEVELS[i].xp)return i+1;
  }
  return 1;
}
function getLevelInfo(){
  const lvl=getLevel();
  const cur=LEVELS[lvl-1];
  const next=LEVELS[lvl]||null;
  return{lvl,name:cur.n,xp:cur.xp,nextXp:next?next.xp:null,nextName:next?next.n:null};
}
function totalUpgrades(){
  let t=0;for(const v of Object.values(S.upgrades))t+=v;return t;
}
function getUserId(){
  return tgUser?String(tgUser.id):'local_'+Math.random().toString(36).slice(2);
}
function getUserName(){
  if(tgUser)return(tgUser.first_name||'')+(tgUser.last_name?' '+tgUser.last_name:'');
  return '–ò–≥—Ä–æ–∫';
}
function getUserUsername(){
  return tgUser&&tgUser.username?tgUser.username:'';
}
function getUserPhoto(){
  return tgUser&&tgUser.photo_url?tgUser.photo_url:null;
}

// ===== FORMAT =====
function fmt(n){
  if(n===undefined||n===null||isNaN(n))return'0';
  n=Math.floor(n);
  if(n>=1e9)return(n/1e9).toFixed(1)+'B';
  if(n>=1e6)return(n/1e6).toFixed(1)+'M';
  if(n>=1e3)return(n/1e3).toFixed(1)+'K';
  return n.toLocaleString('ru');
}
function fmtTime(s){
  s=Math.floor(s);
  if(s>=3600)return Math.floor(s/3600)+'—á '+Math.floor((s%3600)/60)+'–º';
  if(s>=60)return Math.floor(s/60)+'–º '+s%60+'—Å';
  return s+'—Å';
}

// ===== UI =====
let currentTab=0;
function switchTab(idx){
  if(idx===currentTab)return;
  document.querySelectorAll('.page').forEach((p,i)=>{p.classList.toggle('active',i===idx)});
  document.querySelectorAll('.tab-item').forEach((t,i)=>{t.classList.toggle('active',i===idx)});
  currentTab=idx;
  if(idx===1)renderShop();
  if(idx===2)renderCollection();
  if(idx===3)renderAQ();
  if(idx===4)renderBattle();
  if(idx===5)loadLeaderboard();
  if(idx===6)renderProfile();
  haptic('light');
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

function haptic(type){
  if(!S.haptic)return;
  if(tg&&tg.HapticFeedback){
    if(type==='light')tg.HapticFeedback.impactOccurred('light');
    else if(type==='medium')tg.HapticFeedback.impactOccurred('medium');
    else if(type==='heavy')tg.HapticFeedback.impactOccurred('heavy');
    else if(type==='success')tg.HapticFeedback.notificationOccurred('success');
    else if(type==='error')tg.HapticFeedback.notificationOccurred('error');
  }
}

// ===== CLICKER =====
let comboTimer=null;
function doClick(e){
  e.preventDefault();
  if(S.banned)return;
  const now=Date.now();
  // Energy check
  const noEnergy=S.noEnergyUntil&&now<S.noEnergyUntil;
  if(!noEnergy&&S.energy<=0)return showToast('‚ö° –ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!');
  if(!noEnergy)S.energy--;

  // Combo
  if(now-S.lastTapTime<500){
    S.combo++;
    if(S.combo>S.maxCombo)S.maxCombo=S.combo;
  }else{
    S.combo=Math.max(0,S.combo-2);
  }
  S.lastTapTime=now;
  clearTimeout(comboTimer);
  comboTimer=setTimeout(()=>{S.combo=0;updateUI()},2000);

  // Calc tap value
  let val=S.perTap;
  let isCrit=false;
  if(Math.random()<S.critChance){val*=5;isCrit=true}
  const comboMult=S.comboBoostUntil&&now<S.comboBoostUntil?50:(1+Math.floor(S.combo/10)*0.5);
  val=Math.floor(val*comboMult);
  if(S.x2Until&&now<S.x2Until)val*=2;
  val=Math.floor(val*(1+S.magnetBonus));
  
  // XP multiplier from artifacts
  let xpMult=1;
  if(S.activeArtifacts.includes('crown'))xpMult*=1.5;
  if(S.activeArtifacts.includes('book'))xpMult*=2;
  if(S.activeArtifacts.includes('amulet'))val=Math.floor(val*1.5);

  S.coins+=val;
  S.totalEarned+=Math.floor(val*xpMult);
  S.totalTaps++;

  // Floating text
  const rect=document.getElementById('coinBtn').getBoundingClientRect();
  const x=e.touches?e.touches[0].clientX:e.clientX;
  const y=e.touches?e.touches[0].clientY:e.clientY;
  spawnFloating(x||rect.left+rect.width/2,y||rect.top,'+'+fmt(val),isCrit?'var(--yellow)':'var(--green)');

  // Check level up
  checkLevelUp();
  // Random events
  maybeSpawnGolden();
  maybeRandomEvent();
  maybeLuckyBlock();

  haptic(isCrit?'heavy':'light');
  updateUI();
  
  // Auto-save every 50 taps
  if(S.totalTaps%50===0)save();
  // Sync every 100 taps
  if(S.totalTaps%100===0)syncToCloud();
}

function spawnFloating(x,y,text,color){
  const el=document.createElement('div');
  el.className='floating-text';
  el.textContent=text;
  el.style.left=x+'px';el.style.top=y+'px';
  el.style.color=color||'var(--green)';
  el.style.fontSize=(14+Math.min(text.length,6))+'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1000);
}

// ===== GOLDEN COINS =====
let goldenTimeout=null;
function maybeSpawnGolden(){
  if(Math.random()>0.008+S.luckBonus*0.5)return;
  if(document.querySelector('.golden-coin'))return;
  const page=document.getElementById('page-0');
  const rect=page.getBoundingClientRect();
  const g=document.createElement('div');
  g.className='golden-coin';
  g.innerHTML='<svg viewBox="0 0 44 44"><circle cx="22" cy="22" r="20" fill="#ffd700" stroke="#b8860b" stroke-width="2"/><text x="22" y="28" text-anchor="middle" font-size="16" font-weight="bold" fill="#8B6914">‚òÖ</text></svg>';
  g.style.left=(Math.random()*(rect.width-60)+30)+'px';
  g.style.top=(Math.random()*(rect.height-200)+100)+'px';
  g.style.position='absolute';
  g.onclick=()=>{
    const val=S.perTap*20;
    S.coins+=val;S.totalEarned+=val;S.goldenCaught++;
    spawnFloating(parseFloat(g.style.left)+rect.left,parseFloat(g.style.top)+rect.top,'GOLD +'+fmt(val),'#ffd700');
    showToast('üåü –ó–æ–ª–æ—Ç–∞—è –º–æ–Ω–µ—Ç–∞! +'+fmt(val));
    haptic('success');
    g.remove();updateUI();
  };
  page.style.position='relative';
  page.appendChild(g);
  setTimeout(()=>{if(g.parentNode)g.remove()},4000);
}

// ===== RANDOM EVENTS =====
function maybeRandomEvent(){
  if(S.eventActive&&Date.now()<S.eventUntil)return;
  if(Math.random()>0.003)return;
  const events=[
    {id:'x3',text:'üî• –ó–æ–ª–æ—Ç–æ–π —á–∞—Å! x3 –º–æ–Ω–µ—Ç—ã',dur:60000,apply:()=>{S.x2Until=Date.now()+60000}},
    {id:'rain',text:'üåß –î–æ–∂–¥—å –º–æ–Ω–µ—Ç! +500/5—Å',dur:30000,apply:()=>{}},
    {id:'x5tap',text:'üíé –ê–ª–º–∞–∑–Ω–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞! x5 —Ç–∞–ø',dur:30000,apply:()=>{}},
    {id:'noenergy',text:'‚ö° –û–≥–Ω–µ–Ω–Ω—ã–π —à—Ç–æ—Ä–º! –ë–µ–∑ —ç–Ω–µ—Ä–≥–∏–∏',dur:40000,apply:()=>{S.noEnergyUntil=Date.now()+40000}},
  ];
  const ev=events[Math.floor(Math.random()*events.length)];
  S.eventActive=ev.id;S.eventUntil=Date.now()+ev.dur;
  ev.apply();
  showToast(ev.text);
  updateEventBanner();
}

function updateEventBanner(){
  const ban=document.getElementById('eventBanner');
  if(S.eventActive&&Date.now()<S.eventUntil){
    ban.classList.add('show');
    document.getElementById('eventText').textContent=S.eventActive;
    const rem=Math.ceil((S.eventUntil-Date.now())/1000);
    document.getElementById('eventTimer').textContent=rem+'—Å';
  }else{
    ban.classList.remove('show');
    S.eventActive=null;
  }
}

// ===== LUCKY BLOCKS =====
function maybeLuckyBlock(){
  if(Math.random()>0.005)return;
  const rewards=[
    {text:'üí∞ +1000 –º–æ–Ω–µ—Ç!',apply:()=>{S.coins+=1000;S.totalEarned+=1000}},
    {text:'‚≠ê +2 –∑–≤–µ–∑–¥—ã!',apply:()=>{S.gameStars+=2;S.totalStarsEarned+=2}},
    {text:'‚ö° +100 —ç–Ω–µ—Ä–≥–∏–∏!',apply:()=>{S.energy=Math.min(S.energy+100,S.maxEnergy)}},
    {text:'üíé +5000 –º–æ–Ω–µ—Ç!',apply:()=>{S.coins+=5000;S.totalEarned+=5000}},
  ];
  const r=rewards[Math.floor(Math.random()*rewards.length)];
  r.apply();
  showToast('üéÅ –õ–∞–∫–∏ –±–ª–æ–∫! '+r.text);
  haptic('success');
}

// ===== LEVEL UP =====
let lastCheckedLevel=0;
function checkLevelUp(){
  const lvl=getLevel();
  if(lvl>lastCheckedLevel&&lastCheckedLevel>0){
    const info=LEVELS[lvl-1];
    if(info.r>0&&!S.claimedLevelRewards.includes(lvl)){
      S.coins+=info.r;S.totalEarned+=info.r;
      if(info.rs){S.gameStars+=info.rs;S.totalStarsEarned+=info.rs}
      S.claimedLevelRewards.push(lvl);
      showToast('üéâ –£—Ä–æ–≤–µ–Ω—å '+lvl+'! +'+fmt(info.r)+' üí∞'+(info.rs?' +'+info.rs+'‚≠ê':''));
      haptic('success');
    }
  }
  lastCheckedLevel=lvl;
}

// ===== BOSS =====
let bossState=null;
function startBoss(elite){
  const idx=Math.min(S.bossLevel,BOSSES.length-1);
  const b=BOSSES[idx];
  const mult=elite?3:1;
  bossState={hp:b.hp,maxHp:b.hp,time:b.time,reward:b.reward*mult,stars:b.stars*mult,name:b.n+(elite?' (–≠–ª–∏—Ç–Ω—ã–π)':''),svg:b.svg,timer:null,elite:!!elite};
  
  const ov=document.getElementById('bossOverlay');
  ov.classList.add('show');
  document.getElementById('bossName').textContent=bossState.name;
  document.getElementById('bossSprite').innerHTML='<svg viewBox="0 0 100 100" width="120" height="120">'+bossState.svg+'</svg>';
  updateBossUI();
  
  bossState.startTime=Date.now();
  bossState.timer=setInterval(()=>{
    const elapsed=(Date.now()-bossState.startTime)/1000;
    const rem=Math.max(0,bossState.time-elapsed);
    document.getElementById('bossTimer').textContent=Math.ceil(rem);
    if(rem<=0){
      clearInterval(bossState.timer);
      showToast('üíÄ –ë–æ—Å—Å —Å–±–µ–∂–∞–ª!');
      ov.classList.remove('show');
      bossState=null;
    }
  },100);
}

function bossHit(e){
  e.preventDefault();
  if(!bossState)return;
  let dmg=S.perTap;
  if(S.activeArtifacts.includes('sword'))dmg=Math.floor(dmg*1.5);
  if(Math.random()<S.critChance)dmg*=3;
  bossState.hp-=dmg;
  
  const sprite=document.getElementById('bossSprite');
  sprite.classList.remove('shake');
  void sprite.offsetWidth;
  sprite.classList.add('shake');
  
  haptic('medium');
  
  if(bossState.hp<=0){
    clearInterval(bossState.timer);
    S.coins+=bossState.reward;S.totalEarned+=bossState.reward;
    S.gameStars+=bossState.stars;S.totalStarsEarned+=bossState.stars;
    S.bossKills++;
    if(!bossState.elite)S.bossLevel=Math.min(S.bossLevel+1,BOSSES.length-1);
    showToast('üéâ –ë–æ—Å—Å —É–±–∏—Ç! +'+fmt(bossState.reward)+' üí∞ +'+bossState.stars+'‚≠ê');
    haptic('success');
    document.getElementById('bossOverlay').classList.remove('show');
    bossState=null;
    updateUI();save();
    return;
  }
  updateBossUI();
}

function updateBossUI(){
  if(!bossState)return;
  const pct=Math.max(0,bossState.hp/bossState.maxHp*100);
  document.getElementById('bossHpFill').style.width=pct+'%';
  document.getElementById('bossHpText').textContent=fmt(Math.max(0,bossState.hp))+'/'+fmt(bossState.maxHp);
}

// ===== DUEL =====
let duelState=null;
function startDuel(){
  if(S.coins<5000)return showToast('‚ùå –ù—É–∂–Ω–æ 5,000 –º–æ–Ω–µ—Ç!');
  S.coins-=5000;
  
  const ov=document.getElementById('duelOverlay');
  ov.classList.add('show');
  
  // Set my info
  const myAvatar=document.getElementById('duelMyAvatar');
  const photo=getUserPhoto();
  if(photo)myAvatar.innerHTML='<img src="'+photo+'">';
  document.getElementById('duelMyName').textContent=getUserName();
  
  // Opponent from Firebase
  document.getElementById('duelOppName').textContent='–ò—â–µ–º...';
  document.getElementById('duelStatus').textContent='üîç –ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...';
  
  // Find opponent
  findDuelOpponent().then(opp=>{
    document.getElementById('duelOppName').textContent=opp.name;
    if(opp.photo){
      document.getElementById('duelOppAvatar').innerHTML='<img src="'+opp.photo+'">';
    }
    
    duelState={myTaps:0,oppTaps:0,oppSpeed:opp.speed,timer:null,startTime:Date.now(),duration:30,opp};
    document.getElementById('duelMyTaps').textContent='0';
    document.getElementById('duelOppTaps').textContent='0';
    document.getElementById('duelStatus').textContent='‚öîÔ∏è –¢–ê–ü–ê–ô!';
    
    // Opponent auto-taps
    duelState.oppTimer=setInterval(()=>{
      if(!duelState)return;
      const variation=0.5+Math.random()*1.5;
      duelState.oppTaps+=Math.floor(variation);
      document.getElementById('duelOppTaps').textContent=duelState.oppTaps;
    },1000/duelState.oppSpeed);
    
    // Main timer
    duelState.timer=setInterval(()=>{
      if(!duelState)return;
      const elapsed=(Date.now()-duelState.startTime)/1000;
      const rem=Math.max(0,duelState.duration-elapsed);
      document.getElementById('duelTimer').textContent=Math.ceil(rem);
      if(rem<=0)endDuel();
    },100);
  });
}

async function findDuelOpponent(){
  // Try to find real opponent from Firebase
  if(dbConnected){
    try{
      const snap=await db.ref('vriskas_clicker').orderByChild('totalTaps').limitToLast(20).once('value');
      const players=[];
      snap.forEach(c=>{
        const d=c.val();
        if(String(d.tg_id)!==String(getUserId())){
          players.push({name:d.name||'–ò–≥—Ä–æ–∫',photo:d.photo||null,speed:Math.max(2,Math.min(12,(d.totalTaps||0)/Math.max(1,(Date.now()-(d.lastSave||Date.now()))/1000)))});
        }
      });
      if(players.length>0)return players[Math.floor(Math.random()*players.length)];
    }catch(e){}
  }
  // Fallback bot
  const names=['–ë—ã—Å—Ç—Ä—ã–π –ö–ª–∏–∫–µ—Ä','–¢–∞–ø –ú–∞—Å—Ç–µ—Ä','–ü—Ä–æ –ò–≥—Ä–æ–∫','–ù–æ–≤–∏—á–æ–∫','–°–ø–∏–¥—Ä–∞–Ω–Ω–µ—Ä'];
  return{name:names[Math.floor(Math.random()*names.length)],photo:null,speed:3+Math.random()*5};
}

function duelTap(e){
  e.preventDefault();
  if(!duelState)return;
  duelState.myTaps++;
  document.getElementById('duelMyTaps').textContent=duelState.myTaps;
  haptic('light');
}

function endDuel(){
  if(!duelState)return;
  clearInterval(duelState.timer);
  clearInterval(duelState.oppTimer);
  
  const won=duelState.myTaps>duelState.oppTaps;
  if(won){
    S.coins+=9000;S.totalEarned+=9000;
    S.gameStars+=3;S.totalStarsEarned+=3;
    S.duelWins++;
    showToast('üéâ –ü–æ–±–µ–¥–∞! +9,000 üí∞ +3‚≠ê');
    haptic('success');
  }else{
    S.duelLosses++;
    showToast('üò¢ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! '+duelState.myTaps+' vs '+duelState.oppTaps);
    haptic('error');
  }
  
  duelState=null;
  document.getElementById('duelOverlay').classList.remove('show');
  updateUI();save();syncToCloud();
}

// ===== SHOP =====
let shopTab=0;
function renderShop(){
  const tabs=document.getElementById('shopTabs');
  tabs.innerHTML=['üí∞ –ú–æ–Ω–µ—Ç—ã','‚ö° –û—Å–æ–±–æ–µ','‚≠ê Stars'].map((t,i)=>
    '<div class="shop-tab'+(shopTab===i?' active':'')+'" onclick="shopTab='+i+';renderShop()">'+t+'</div>'
  ).join('');
  
  const list=document.getElementById('shopList');
  if(shopTab===0){
    list.innerHTML=UPGRADES.map(u=>{
      const lvl=S.upgrades[u.id]||0;
      const price=Math.floor(u.base*Math.pow(u.mult,lvl));
      const maxed=lvl>=u.max;
      const afford=S.coins>=price;
      return '<div class="shop-item"><div class="shop-icon">'+u.icon+'</div><div class="shop-info"><div class="shop-name">'+u.n+'</div><div class="shop-desc">'+u.desc+'</div><div class="shop-meta"><span class="shop-lvl">–£—Ä.'+lvl+(u.max?'/'+u.max:'')+'</span></div></div><button class="shop-btn '+(maxed?'expensive':afford?'affordable':'expensive')+'" onclick="buyUpgrade(\''+u.id+'\')" '+(maxed||!afford?'disabled':'')+'>'+
      (maxed?'–ú–ê–ö–°':'üí∞ '+fmt(price))+'</button></div>';
    }).join('');
  }else if(shopTab===1){
    list.innerHTML=SPECIALS.map(s=>{
      if(s.costStars){
        return '<div class="shop-item"><div class="shop-icon">'+s.icon+'</div><div class="shop-info"><div class="shop-name">'+s.n+'</div><div class="shop-desc">'+s.desc+'</div></div><button class="shop-btn '+(S.gameStars>=s.costStars?'affordable':'expensive')+'" onclick="buySpecial(\''+s.id+'\')" '+(S.gameStars<s.costStars?'disabled':'')+'>‚≠ê'+s.costStars+'</button></div>';
      }
      return '<div class="shop-item"><div class="shop-icon">'+s.icon+'</div><div class="shop-info"><div class="shop-name">'+s.n+'</div><div class="shop-desc">'+s.desc+'</div></div><button class="shop-btn '+(S.coins>=s.price?'affordable':'expensive')+'" onclick="buySpecial(\''+s.id+'\')" '+(S.coins<s.price?'disabled':'')+'>üí∞'+fmt(s.price)+'</button></div>';
    }).join('');
  }else{
    list.innerHTML=STAR_ITEMS.map(s=>
      '<div class="shop-item"><div class="shop-icon">‚≠ê</div><div class="shop-info"><div class="shop-name">'+s.n+'</div><div class="shop-desc">'+s.desc+'</div></div><button class="shop-btn affordable" onclick="buyStarItem(\''+s.id+'\')">‚≠ê'+s.stars+' Stars</button></div>'
    ).join('');
  }
}

function buyUpgrade(id){
  const u=UPGRADES.find(x=>x.id===id);if(!u)return;
  const lvl=S.upgrades[u.id]||0;
  if(lvl>=u.max)return showToast('‚ùå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!');
  const price=Math.floor(u.base*Math.pow(u.mult,lvl));
  if(S.coins<price)return showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
  S.coins-=price;
  S.upgrades[u.id]=(S.upgrades[u.id]||0)+1;
  recalcStats();
  showToast('‚úÖ '+u.n+' ‚Üí –£—Ä.'+(lvl+1));
  haptic('success');
  renderShop();updateUI();save();
}

function buySpecial(id){
  const s=SPECIALS.find(x=>x.id===id);if(!s)return;
  if(s.costStars){
    if(S.gameStars<s.costStars)return showToast('‚ùå –ù—É–∂–Ω–æ '+s.costStars+'‚≠ê!');
    S.gameStars-=s.costStars;
  }else{
    if(S.coins<s.price)return showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!');
    S.coins-=s.price;
  }
  switch(s.type){
    case'refill':S.energy=S.maxEnergy;showToast('‚ö° –≠–Ω–µ—Ä–≥–∏—è –ø–æ–ª–Ω–∞—è!');break;
    case'x2':S.x2Until=Date.now()+60000;showToast('üí∞ x2 –º–æ–Ω–µ—Ç—ã –Ω–∞ 60—Å!');break;
    case'combo':S.combo=50;S.maxCombo=Math.max(S.maxCombo,50);showToast('üî• –ú–ï–ì–ê –ö–û–ú–ë–û x50!');break;
    case'elite_boss':startBoss(true);break;
    case'timeskip':const e=getCPS()*7200;S.coins+=e;S.totalEarned+=e;showToast('‚è∞ +'+fmt(e)+' –º–æ–Ω–µ—Ç!');break;
    case'buystars':S.gameStars+=10;S.totalStarsEarned+=10;showToast('‚≠ê +10 –∑–≤—ë–∑–¥!');break;
    case'starboost':S.perTap+=5;showToast('üåü +5 –∫ —Ç–∞–ø—É!');break;
    case'coinpack':S.coins+=5000;S.totalEarned+=5000;showToast('üí∞ +5000 –º–æ–Ω–µ—Ç!');break;
  }
  haptic('success');
  renderShop();updateUI();save();
}

// ===== STAR PURCHASES (Telegram Stars) =====
let preCheckoutPolling=null;
function startPreCheckoutPolling(){
  let offset=0;
  preCheckoutPolling=setInterval(async()=>{
    try{
      const r=await fetch('https://api.telegram.org/bot'+BOT_TOKEN+'/getUpdates?offset='+offset+'&timeout=1&allowed_updates=["pre_checkout_query"]');
      const d=await r.json();
      if(d.ok&&d.result){
        for(const u of d.result){
          offset=u.update_id+1;
          if(u.pre_checkout_query){
            await fetch('https://api.telegram.org/bot'+BOT_TOKEN+'/answerPreCheckoutQuery',{
              method:'POST',headers:{'Content-Type':'application/json'},
              body:JSON.stringify({pre_checkout_query_id:u.pre_checkout_query.id,ok:true})
            });
          }
        }
      }
    }catch(e){}
  },1500);
}
function stopPreCheckoutPolling(){
  if(preCheckoutPolling){clearInterval(preCheckoutPolling);preCheckoutPolling=null}
}

async function buyStarItem(id){
  const item=STAR_ITEMS.find(x=>x.id===id);if(!item)return;
  if(!tg)return showToast('‚ùå –¢–æ–ª—å–∫–æ –≤ Telegram!');
  try{
    startPreCheckoutPolling();
    const r=await fetch('https://api.telegram.org/bot'+BOT_TOKEN+'/createInvoiceLink',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        title:item.n,description:item.desc,
        payload:JSON.stringify({item_id:item.id,user_id:getUserId()}),
        provider_token:'',currency:'XTR',
        prices:[{label:item.n,amount:item.stars}]
      })
    });
    const d=await r.json();
    if(!d.ok){stopPreCheckoutPolling();return showToast('‚ùå –û—à–∏–±–∫–∞: '+(d.description||'unknown'))}
    tg.openInvoice(d.result,(status)=>{
      setTimeout(stopPreCheckoutPolling,5000);
      if(status==='paid'){
        applyStarPurchase(item);
        showToast('‚úÖ –ö—É–ø–ª–µ–Ω–æ: '+item.n);
        haptic('success');
        save();syncToCloud();
      }else if(status==='failed'){
        showToast('‚ùå –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã');
      }
    });
  }catch(e){
    stopPreCheckoutPolling();
    showToast('‚ùå –û—à–∏–±–∫–∞: '+e.message);
  }
}

function applyStarPurchase(item){
  if(item.eff==='perTap')S.perTap+=item.val;
  if(item.eff==='maxEnergy'){S.maxEnergy+=item.val;S.energy=S.maxEnergy}
  if(item.eff==='cps')S.cps+=item.val;
  if(item.eff==='regen')S.regen+=item.val;
  if(item.eff==='coins'){S.coins+=item.val;S.totalEarned+=item.val}
  if(item.eff==='gameStars'){S.gameStars+=item.val;S.totalStarsEarned+=item.val}
  S.starsPurchases.push(item.id);
  recalcStats();updateUI();
}

// Test payment
async function testPayment(){
  if(!tg)return showToast('‚ùå –¢–æ–ª—å–∫–æ –≤ Telegram!');
  try{
    startPreCheckoutPolling();
    const r=await fetch('https://api.telegram.org/bot'+BOT_TOKEN+'/createInvoiceLink',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        title:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã',description:'1 –∑–≤–µ–∑–¥–∞ ‚Üí –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç',
        payload:'test_'+getUserId()+'_'+Date.now(),
        provider_token:'',currency:'XTR',
        prices:[{label:'–¢–µ—Å—Ç',amount:1}]
      })
    });
    const d=await r.json();
    if(!d.ok){stopPreCheckoutPolling();return showToast('‚ùå '+d.description)}
    tg.openInvoice(d.result,async(status)=>{
      setTimeout(stopPreCheckoutPolling,5000);
      if(status==='paid'){
        // Refund
        try{
          await fetch('https://api.telegram.org/bot'+BOT_TOKEN+'/refundStarPayment',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id:parseInt(getUserId()),telegram_payment_charge_id:'test'})
          });
        }catch(e){}
        showToast('üéâ –û–ø–ª–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç! –ó–≤–µ–∑–¥–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∞!');
        haptic('success');
      }
    });
  }catch(e){
    stopPreCheckoutPolling();
    showToast('‚ùå '+e.message);
  }
}

// ===== COLLECTION =====
let collTab=0;
function switchCollTab(idx){
  collTab=idx;
  document.querySelectorAll('#collTabs .shop-tab').forEach((t,i)=>t.classList.toggle('active',i===idx));
  renderCollection();
}

function renderCollection(){
  const el=document.getElementById('collContent');
  if(collTab===0)renderSkins(el);
  else if(collTab===1)renderPets(el);
  else if(collTab===2)renderArtifacts(el);
  else renderWorlds(el);
}

function renderSkins(el){
  el.innerHTML='<div class="skins-grid">'+SKINS.map(s=>{
    const owned=S.ownedSkins.includes(s.id);
    const active=S.activeSkin===s.id;
    const bonusText=Object.entries(s.bonus).map(([k,v])=>'+'+v+' '+(k==='perTap'?'—Ç–∞–ø':k==='cps'?'/—Å':k==='regen'?'—Ä–µ–≥':k==='energy'?'‚ö°':k)).join(', ');
    return '<div class="skin-card'+(active?' active':'')+(owned?'':' locked')+'" onclick="selectSkin(\''+s.id+'\')"><div class="skin-svg"><svg viewBox="0 0 100 100">'+s.svg+'</svg></div><div class="skin-name">'+s.n+'</div>'+(bonusText?'<div class="skin-bonus">'+bonusText+'</div>':'')+(owned?'<div style="font-size:9px;color:var(--green)">‚úì</div>':'<div class="skin-price">üí∞ '+fmt(s.price)+'</div>')+'</div>';
  }).join('')+'</div>';
}

function selectSkin(id){
  const s=SKINS.find(x=>x.id===id);if(!s)return;
  if(S.ownedSkins.includes(id)){
    S.activeSkin=id;
    document.getElementById('coinSvg').innerHTML=s.svg;
    showToast('üé® –°–∫–∏–Ω: '+s.n);
  }else{
    if(S.coins<s.price)return showToast('‚ùå –ù—É–∂–Ω–æ '+fmt(s.price)+' –º–æ–Ω–µ—Ç!');
    S.coins-=s.price;S.ownedSkins.push(id);S.activeSkin=id;
    document.getElementById('coinSvg').innerHTML=s.svg;
    showToast('‚úÖ –°–∫–∏–Ω –∫—É–ø–ª–µ–Ω: '+s.n);
    haptic('success');
  }
  recalcStats();renderCollection();updateUI();save();
}

function renderPets(el){
  el.innerHTML='<div class="pets-grid">'+PETS.map(p=>{
    const owned=S.ownedPets.includes(p.id);
    const active=S.activePet===p.id;
    const bonusText=Object.entries(p.bonus).map(([k,v])=>'+'+v+' '+(k==='perTap'?'—Ç–∞–ø':'/—Å')).join(', ');
    return '<div class="pet-card'+(active?' active':'')+(owned?'':' locked')+'" onclick="selectPet(\''+p.id+'\')"><div class="pet-icon">'+p.icon+'</div><div class="pet-name">'+p.n+'</div><div class="pet-bonus">'+bonusText+'</div>'+(owned?'<div style="font-size:9px;color:var(--green)">‚úì</div>':'<div style="font-size:10px;color:var(--orange)">üí∞ '+fmt(p.price)+'</div>')+'</div>';
  }).join('')+'</div>';
}

function selectPet(id){
  const p=PETS.find(x=>x.id===id);if(!p)return;
  if(S.ownedPets.includes(id)){
    S.activePet=S.activePet===id?null:id;
    showToast(S.activePet?'üêæ –ü–∏—Ç–æ–º–µ—Ü: '+p.n:'üêæ –ü–∏—Ç–æ–º–µ—Ü —É–±—Ä–∞–Ω');
  }else{
    if(S.coins<p.price)return showToast('‚ùå –ù—É–∂–Ω–æ '+fmt(p.price)+' –º–æ–Ω–µ—Ç!');
    S.coins-=p.price;S.ownedPets.push(id);S.activePet=id;
    showToast('‚úÖ –ü–∏—Ç–æ–º–µ—Ü –∫—É–ø–ª–µ–Ω: '+p.n);
    haptic('success');
  }
  recalcStats();renderCollection();updateUI();save();
}

function renderArtifacts(el){
  el.innerHTML=ARTIFACTS.map(a=>{
    const owned=S.ownedArtifacts.includes(a.id);
    const active=S.activeArtifacts.includes(a.id);
    return '<div class="artifact-card'+(active?' active':'')+(owned?'':' locked')+'" onclick="selectArtifact(\''+a.id+'\')"><div class="artifact-icon">'+a.icon+'</div><div style="flex:1"><div style="font-size:13px;font-weight:700">'+a.n+'</div><div style="font-size:11px;color:var(--text2)">'+a.desc+'</div></div>'+(owned?'<div style="font-size:10px;color:var(--green)">‚úì</div>':'<div style="font-size:11px;color:var(--orange)">üí∞'+fmt(a.price)+'</div>')+'</div>';
  }).join('');
}

function selectArtifact(id){
  const a=ARTIFACTS.find(x=>x.id===id);if(!a)return;
  if(S.ownedArtifacts.includes(id)){
    if(S.activeArtifacts.includes(id)){
      S.activeArtifacts=S.activeArtifacts.filter(x=>x!==id);
      showToast('üîÆ –°–Ω—è—Ç: '+a.n);
    }else{
      if(S.activeArtifacts.length>=3)return showToast('‚ùå –ú–∞–∫—Å 3 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞!');
      S.activeArtifacts.push(id);
      showToast('üîÆ –ù–∞–¥–µ—Ç: '+a.n);
    }
  }else{
    if(S.coins<a.price)return showToast('‚ùå –ù—É–∂–Ω–æ '+fmt(a.price)+' –º–æ–Ω–µ—Ç!');
    S.coins-=a.price;S.ownedArtifacts.push(id);S.activeArtifacts.push(id);
    if(S.activeArtifacts.length>3)S.activeArtifacts=S.activeArtifacts.slice(-3);
    showToast('‚úÖ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: '+a.n);
    haptic('success');
  }
  recalcStats();renderCollection();updateUI();save();
}

function renderWorlds(el){
  const lvl=getLevel();
  el.innerHTML=WORLDS.map(w=>{
    const unlocked=S.unlockedWorlds.includes(w.id);
    const active=S.activeWorld===w.id;
    const canUnlock=lvl>=w.lvl;
    return '<div class="world-card'+(active?' active':'')+(unlocked?'':' locked')+'" onclick="selectWorld(\''+w.id+'\')" '+(unlocked||canUnlock?'':'style="pointer-events:none"')+'><div style="font-size:32px">'+w.icon+'</div><div style="flex:1"><div style="font-size:14px;font-weight:700">'+w.n+'</div><div style="font-size:11px;color:var(--text2)">'+w.desc+'</div>'+(unlocked?'':'<div style="font-size:10px;color:var(--orange)">–ù—É–∂–µ–Ω —É—Ä.'+w.lvl+'</div>')+'</div>'+(active?'<div style="font-size:10px;color:var(--green)">‚úì –ê–∫—Ç–∏–≤–µ–Ω</div>':'')+'</div>';
  }).join('');
}

function selectWorld(id){
  const w=WORLDS.find(x=>x.id===id);if(!w)return;
  const lvl=getLevel();
  if(!S.unlockedWorlds.includes(id)){
    if(lvl<w.lvl)return showToast('‚ùå –ù—É–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å '+w.lvl+'!');
    S.unlockedWorlds.push(id);
    showToast('üåç –ú–∏—Ä –æ—Ç–∫—Ä—ã—Ç: '+w.n);
    haptic('success');
  }
  S.activeWorld=id;
  recalcStats();renderCollection();updateUI();save();
}

// ===== ACHIEVEMENTS & QUESTS =====
let aqTab=0;
function switchAQTab(idx){
  aqTab=idx;
  document.getElementById('aqTab0').classList.toggle('active',idx===0);
  document.getElementById('aqTab1').classList.toggle('active',idx===1);
  renderAQ();
}

function renderAQ(){
  const el=document.getElementById('aqContent');
  if(aqTab===0)renderAchievements(el);
  else renderQuests(el);
}

function renderAchievements(el){
  checkAchievements();
  el.innerHTML=ACHIEVEMENTS.map(a=>{
    const done=S.achievements.includes(a.id);
    return '<div class="ach-item'+(done?' done':'')+'"><div class="ach-icon">'+(done?'‚úÖ':'üîí')+'</div><div class="ach-info"><div class="ach-name">'+a.n+'</div><div class="ach-desc">'+a.d+'</div></div>'+(a.r?'<div class="ach-reward">+'+fmt(a.r)+'üí∞</div>':'')+'</div>';
  }).join('');
}

function checkAchievements(){
  for(const a of ACHIEVEMENTS){
    if(S.achievements.includes(a.id))continue;
    if(a.g()){
      S.achievements.push(a.id);
      if(a.r){S.coins+=a.r;S.totalEarned+=a.r}
      showToast('üèÖ '+a.n+'!'+(a.r?' +'+fmt(a.r):''));
      haptic('success');
    }
  }
}

function renderQuests(el){
  const quests=getDailyQuests();
  const today=Math.floor(Date.now()/(24*60*60*1000));
  if(!S.dailyQuestProg||S.dailyQuestDay!==today){
    S.dailyQuestProg={};S.dailyQuestClaimed={};S.dailyQuestDay=today;
  }
  
  el.innerHTML='<div class="card"><div class="card-title">üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</div>'+
    '<button class="btn btn-primary" onclick="claimDaily()" '+(canClaimDaily()?'':'disabled')+'>'+
    (canClaimDaily()?'–ó–∞–±—Ä–∞—Ç—å! (—Å–µ—Ä–∏—è: '+S.dailyStreak+')':'–£–∂–µ –∑–∞–±—Ä–∞–ª —Å–µ–≥–æ–¥–Ω—è')+'</button></div>'+
    quests.map((q,i)=>{
      const prog=S.dailyQuestProg[q.key]||0;
      const done=prog>=q.need;
      const claimed=S.dailyQuestClaimed[i];
      return '<div class="quest-item'+(claimed?' done':'')+'"><div class="quest-icon">'+(claimed?'‚úÖ':done?'üéÅ':'üìã')+'</div><div class="quest-info"><div class="quest-name">'+q.n+'</div><div class="quest-prog"><div class="quest-prog-fill" style="width:'+Math.min(100,prog/q.need*100)+'%"></div></div><div style="font-size:10px;color:var(--text2);margin-top:2px">'+Math.min(prog,q.need)+'/'+q.need+'</div></div><div class="quest-reward">'+(claimed?'‚úì':done?'<button class="shop-btn affordable" style="padding:4px 8px;font-size:10px" onclick="claimQuest('+i+')">+'+fmt(q.r)+'</button>':'+'+fmt(q.r))+'</div></div>';
    }).join('');
}

function claimQuest(idx){
  const quests=getDailyQuests();
  const q=quests[idx];
  if(!q||S.dailyQuestClaimed[idx])return;
  const prog=S.dailyQuestProg[q.key]||0;
  if(prog<q.need)return;
  S.dailyQuestClaimed[idx]=true;
  S.coins+=q.r;S.totalEarned+=q.r;
  if(q.rs){S.gameStars+=q.rs;S.totalStarsEarned+=q.rs}
  showToast('üìã –ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! +'+fmt(q.r));
  haptic('success');
  renderAQ();updateUI();save();
}

function canClaimDaily(){
  const today=Math.floor(Date.now()/(24*60*60*1000));
  return S.lastDaily!==today;
}

function claimDaily(){
  if(!canClaimDaily())return;
  const today=Math.floor(Date.now()/(24*60*60*1000));
  if(S.lastDaily===today-1)S.dailyStreak++;
  else if(S.lastDaily!==today)S.dailyStreak=1;
  S.lastDaily=today;
  const reward=Math.floor(500*S.dailyStreak);
  const stars=Math.min(S.dailyStreak,10);
  S.coins+=reward;S.totalEarned+=reward;
  S.gameStars+=stars;S.totalStarsEarned+=stars;
  showToast('üéÅ –î–µ–Ω—å '+S.dailyStreak+'! +'+fmt(reward)+' üí∞ +'+stars+'‚≠ê');
  haptic('success');
  renderAQ();updateUI();save();
}

// ===== BATTLE =====
function renderBattle(){
  document.getElementById('bossKills').textContent=S.bossKills;
  document.getElementById('duelWins').textContent=S.duelWins;
  document.getElementById('duelLosses').textContent=S.duelLosses;
}

// ===== LEADERBOARD =====
let lbTab=0;
function switchLbTab(idx){
  lbTab=idx;
  document.getElementById('lbTab0').classList.toggle('active',idx===0);
  document.getElementById('lbTab1').classList.toggle('active',idx===1);
  loadLeaderboard();
}

async function loadLeaderboard(){
  const el=document.getElementById('lbList');
  if(!dbConnected){el.innerHTML='<div style="text-align:center;padding:40px;color:var(--text2)">‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';return}
  try{
    const field=lbTab===0?'totalEarned':'totalTaps';
    const snap=await db.ref('vriskas_clicker').orderByChild(field).limitToLast(50).once('value');
    const players=[];
    snap.forEach(c=>{
      const d=c.val();
      if(!d.banned)players.push(d);
    });
    players.sort((a,b)=>(b[field]||0)-(a[field]||0));
    
    if(players.length===0){
      el.innerHTML='<div style="text-align:center;padding:40px;color:var(--text2)">üèÜ –ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ë—É–¥—å –ø–µ—Ä–≤—ã–º!</div>';
      return;
    }
    
    const uid=getUserId();
    const medals=['ü•á','ü•à','ü•â'];
    el.innerHTML=players.map((p,i)=>{
      const isMe=String(p.tg_id)===String(uid);
      const rank=i<3?medals[i]:(i+1);
      return '<div class="lb-item'+(isMe?' me':'')+'"><div class="lb-rank">'+rank+'</div><div class="lb-avatar">'+(p.photo?'<img src="'+p.photo+'">':'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><circle cx="12" cy="7" r="4"/><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/></svg>')+'</div><div class="lb-info"><div class="lb-name">'+((p.name||'–ò–≥—Ä–æ–∫')+(isMe?' (—Ç—ã)':''))+'</div><div class="lb-sub">–£—Ä.'+getLevelByXP(p.totalEarned||0)+'</div></div><div class="lb-val">'+fmt(p[field]||0)+'</div></div>';
    }).join('');
  }catch(e){
    el.innerHTML='<div style="text-align:center;padding:40px;color:var(--text2)">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
  }
}

function getLevelByXP(xp){
  for(let i=LEVELS.length-1;i>=0;i--){if(xp>=LEVELS[i].xp)return i+1}
  return 1;
}

// ===== ROULETTE =====
function openRoulette(){
  document.getElementById('rouletteModal').classList.add('show');
  drawRoulette(0);
  const now=Date.now();
  const canSpin=!S.lastRoulette||now-S.lastRoulette>=1800000;
  const btn=document.getElementById('rouletteBtn');
  if(canSpin){btn.disabled=false;btn.textContent='–ö—Ä—É—Ç–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ!'}
  else{
    const rem=Math.ceil((1800000-(now-S.lastRoulette))/1000);
    btn.disabled=true;btn.textContent='–ß–µ—Ä–µ–∑ '+fmtTime(rem);
  }
}

const ROULETTE_PRIZES=[
  {text:'100',val:100,color:'#ef4444'},{text:'500',val:500,color:'#f97316'},
  {text:'1K',val:1000,color:'#eab308'},{text:'2K',val:2000,color:'#22c55e'},
  {text:'5K',val:5000,color:'#3b82f6'},{text:'10K',val:10000,color:'#8b5cf6'},
  {text:'25K',val:25000,color:'#ec4899'},{text:'50K',val:50000,color:'#14b8a6'},
];

function drawRoulette(angle){
  const canvas=document.getElementById('rouletteCanvas');
  const ctx=canvas.getContext('2d');
  const cx=260,cy=260,r=240;
  ctx.clearRect(0,0,520,520);
  const n=ROULETTE_PRIZES.length;
  const arc=2*Math.PI/n;
  for(let i=0;i<n;i++){
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,angle+i*arc,angle+(i+1)*arc);
    ctx.fillStyle=ROULETTE_PRIZES[i].color;
    ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,0.3)';ctx.lineWidth=2;ctx.stroke();
    // Text
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle+(i+0.5)*arc);
    ctx.fillStyle='#fff';ctx.font='bold 20px Inter';ctx.textAlign='center';
    ctx.fillText(ROULETTE_PRIZES[i].text,r*0.6,6);
    ctx.restore();
  }
  // Center
  ctx.beginPath();ctx.arc(cx,cy,20,0,2*Math.PI);ctx.fillStyle='#fff';ctx.fill();
}

function spinRoulette(){
  const now=Date.now();
  if(S.lastRoulette&&now-S.lastRoulette<1800000)return;
  S.lastRoulette=now;S.rouletteSpins++;
  
  const btn=document.getElementById('rouletteBtn');
  btn.disabled=true;btn.textContent='–ö—Ä—É—Ç–∏—Ç—Å—è...';
  
  const winIdx=Math.floor(Math.random()*ROULETTE_PRIZES.length);
  const n=ROULETTE_PRIZES.length;
  const targetAngle=-(winIdx+0.5)*(2*Math.PI/n)+Math.PI/2;
  const totalRotation=targetAngle+2*Math.PI*6;
  
  let start=null;const duration=4000;
  function animate(ts){
    if(!start)start=ts;
    const p=Math.min(1,(ts-start)/duration);
    const ease=1-Math.pow(1-p,4);
    drawRoulette(ease*totalRotation);
    if(p<1)requestAnimationFrame(animate);
    else{
      const prize=ROULETTE_PRIZES[winIdx];
      S.coins+=prize.val;S.totalEarned+=prize.val;
      showToast('üé∞ –í—ã–∏–≥—Ä—ã—à: +'+prize.text+' –º–æ–Ω–µ—Ç!');
      haptic('success');
      btn.textContent='–ß–µ—Ä–µ–∑ 30–º';
      updateUI();save();
    }
  }
  requestAnimationFrame(animate);
}

// ===== SECRET CODES =====
function openCodeInput(){
  document.getElementById('codeModal').classList.add('show');
  document.getElementById('codeInput').value='';
  document.getElementById('codeInput').focus();
}

function submitCode(){
  const code=document.getElementById('codeInput').value.trim().toUpperCase();
  if(!code)return;
  if(S.usedCodes.includes(code))return showToast('‚ùå –ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω!');
  const reward=CODES[code];
  if(!reward)return showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥!');
  S.usedCodes.push(code);S.codesUsed++;
  if(reward.coins){S.coins+=reward.coins;S.totalEarned+=reward.coins}
  if(reward.stars){S.gameStars+=reward.stars;S.totalStarsEarned+=reward.stars}
  if(reward.refill)S.energy=S.maxEnergy;
  if(reward.boss)startBoss(false);
  showToast('üîë '+reward.msg);
  haptic('success');
  closeModal('codeModal');
  updateUI();save();
}

function closeModal(id){document.getElementById(id).classList.remove('show')}

// ===== PROFILE =====
function renderProfile(){
  const photo=getUserPhoto();
  if(photo){
    document.getElementById('profileAvatar').innerHTML='<img src="'+photo+'">';
    document.getElementById('headerAvatar').innerHTML='<img src="'+photo+'">';
  }
  document.getElementById('profileName').textContent=getUserName();
  document.getElementById('headerName').textContent=getUserName();
  const un=getUserUsername();
  document.getElementById('profileUsername').textContent=un?'@'+un:'';
  
  const li=getLevelInfo();
  document.getElementById('profileBadges').innerHTML=
    '<span class="badge gold">–£—Ä.'+li.lvl+' '+li.name+'</span>'+
    (S.isBillionaire?'<span class="badge gold">üí∞ –ú–∏–ª–ª–∏–∞—Ä–¥–µ—Ä</span>':'')+
    '<span class="badge">üëÜ '+fmt(S.totalTaps)+' —Ç–∞–ø–æ–≤</span>'+
    '<span class="badge">‚≠ê '+S.gameStars+'</span>';
  
  document.getElementById('statsGrid').innerHTML=
    '<div class="stat-card"><div class="stat-val">'+fmt(S.coins)+'</div><div class="stat-lbl">–ú–æ–Ω–µ—Ç—ã</div></div>'+
    '<div class="stat-card"><div class="stat-val">'+fmt(S.totalEarned)+'</div><div class="stat-lbl">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div></div>'+
    '<div class="stat-card"><div class="stat-val">'+fmt(S.totalTaps)+'</div><div class="stat-lbl">–¢–∞–ø–æ–≤</div></div>'+
    '<div class="stat-card"><div class="stat-val">'+S.gameStars+'</div><div class="stat-lbl">‚≠ê –ó–≤—ë–∑–¥</div></div>'+
    '<div class="stat-card"><div class="stat-val">'+fmt(S.perTap)+'</div><div class="stat-lbl">–ó–∞ —Ç–∞–ø</div></div>'+
    '<div class="stat-card"><div class="stat-val">'+fmt(getCPS())+'</div><div class="stat-lbl">–í —Å–µ–∫—É–Ω–¥—É</div></div>'+
    '<div class="stat-card"><div class="stat-val">'+S.bossKills+'</div><div class="stat-lbl">–ë–æ—Å—Å–æ–≤</div></div>'+
    '<div class="stat-card"><div class="stat-val">'+S.duelWins+'</div><div class="stat-lbl">–ü–æ–±–µ–¥</div></div>';
  
  // Billionaire button
  if(!document.getElementById('billionaireBtn')&&!S.isBillionaire){
    const btn=document.createElement('button');
    btn.id='billionaireBtn';
    btn.className='btn';
    btn.style.cssText='margin-top:12px;background:linear-gradient(135deg,#ffd700,#ff6b00,#ff0080,#7c3aed,#0ea5e9);background-size:300% 300%;animation:gradShift 3s infinite;';
    btn.textContent='üíé –°—Ç–∞—Ç—å –º–∏–ª–ª–∏–∞—Ä–¥–µ—Ä–æ–º (1,000,000,000 –º–æ–Ω–µ—Ç)';
    btn.onclick=()=>{
      if(S.coins<1e9)return showToast('‚ùå –ù—É–∂–µ–Ω 1 –º–∏–ª–ª–∏–∞—Ä–¥ –º–æ–Ω–µ—Ç!');
      S.coins-=1e9;S.isBillionaire=true;
      showToast('üëë –¢–´ –ú–ò–õ–õ–ò–ê–†–î–ï–†!');haptic('success');
      renderProfile();updateUI();save();
    };
    document.getElementById('statsGrid').after(btn);
  }
  
  // Admin panel
  renderAdmin();
  
  // Style toggle state
  document.getElementById('styleToggle').classList.toggle('on',S.style==='material');
  document.getElementById('styleDesc').textContent=S.style==='ios'?'iOS':'Material You';
  document.getElementById('hapticToggle').classList.toggle('on',S.haptic);
  document.getElementById('soundToggle').classList.toggle('on',S.sound);
}

function toggleStyle(){
  S.style=S.style==='ios'?'material':'ios';
  document.body.classList.toggle('style-ios',S.style==='ios');
  document.body.classList.toggle('style-material',S.style==='material');
  document.getElementById('styleToggle').classList.toggle('on',S.style==='material');
  document.getElementById('styleDesc').textContent=S.style==='ios'?'iOS':'Material You';
  save();
}
function toggleHaptic(){S.haptic=!S.haptic;document.getElementById('hapticToggle').classList.toggle('on',S.haptic);save()}
function toggleSound(){S.sound=!S.sound;document.getElementById('soundToggle').classList.toggle('on',S.sound);save()}

function shareBot(){
  if(tg)tg.openTelegramLink('https://t.me/share/url?url=https://t.me/VriskasRobot&text=–ò–≥—Ä–∞–π –≤ Vriskas Clicker!');
}

function resetProgress(){
  if(!confirm('–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?'))return;
  const uid=getUserId();
  localStorage.removeItem(SAVE_KEY);
  if(dbConnected)db.ref('vriskas_clicker/'+uid).remove();
  location.reload();
}

// ===== ADMIN =====
function renderAdmin(){
  const panel=document.getElementById('adminPanel');
  const username=getUserUsername();
  if(username!==ADMIN_USERNAME){panel.innerHTML='';return}
  
  panel.innerHTML=`
    <div class="admin-section" style="margin-top:16px">
      <div class="admin-title">üîß –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
        <button class="btn btn-primary" style="flex:1;min-width:120px;font-size:12px" onclick="adminLoadPlayers()">üìã –ò–≥—Ä–æ–∫–∏</button>
        <button class="btn btn-orange" style="flex:1;min-width:120px;font-size:12px" onclick="adminStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button class="btn btn-red" style="flex:1;min-width:120px;font-size:12px" onclick="adminResetAll()">üóë –†–µ—Å–µ—Ç –í–°–ï–•</button>
      </div>
      <div style="margin-bottom:8px">
        <input class="admin-input" id="adminSearchId" placeholder="User ID –¥–ª—è –ø–æ–∏—Å–∫–∞...">
        <button class="btn btn-dark" style="font-size:12px;margin-top:4px" onclick="adminSearchPlayer()">üîç –ù–∞–π—Ç–∏</button>
      </div>
      <div id="adminContent"></div>
    </div>
  `;
}

async function adminLoadPlayers(){
  const el=document.getElementById('adminContent');
  if(!dbConnected){el.innerHTML='<div style="color:var(--red)">‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';return}
  el.innerHTML='<div style="color:var(--text2)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try{
    const snap=await db.ref('vriskas_clicker').once('value');
    const players=[];
    snap.forEach(c=>{players.push({key:c.key,...c.val()})});
    players.sort((a,b)=>(b.totalEarned||0)-(a.totalEarned||0));
    
    el.innerHTML=players.map(p=>
      '<div class="admin-player'+(p.banned?' banned':'')+'">'+
      '<div style="flex:1;min-width:0"><div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(p.name||'???')+' '+(p.banned?'üö´':'')+'</div><div style="font-size:10px;color:var(--text2)">ID:'+p.key+' | üí∞'+fmt(p.totalEarned||0)+' | üëÜ'+fmt(p.totalTaps||0)+'</div></div>'+
      '<div style="display:flex;gap:4px">'+
      '<button class="shop-btn affordable" style="padding:4px 8px;font-size:10px" onclick="adminEditPlayer(\''+p.key+'\')">‚úèÔ∏è</button>'+
      '<button class="shop-btn '+(p.banned?'affordable':'expensive')+'" style="padding:4px 8px;font-size:10px;background:'+(p.banned?'var(--green)':'var(--red)')+';color:#fff" onclick="adminToggleBan(\''+p.key+'\','+(!p.banned)+')">'+(p.banned?'–†–∞–∑–±–∞–Ω':'–ë–∞–Ω')+'</button>'+
      '<button class="shop-btn expensive" style="padding:4px 8px;font-size:10px;background:var(--red);color:#fff" onclick="adminDeletePlayer(\''+p.key+'\')">üóë</button>'+
      '</div></div>'
    ).join('');
  }catch(e){el.innerHTML='<div style="color:var(--red)">‚ùå '+e.message+'</div>'}
}

async function adminToggleBan(uid,ban){
  if(!dbConnected)return showToast('‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
  try{
    const updates={banned:ban,adminForceUpdate:true,adminTimestamp:Date.now()};
    if(ban){updates.coins=0;updates.totalEarned=0;updates.totalTaps=0;updates.gameStars=0}
    await db.ref('vriskas_clicker/'+uid).update(updates);
    showToast(ban?'üö´ –ó–∞–±–∞–Ω–µ–Ω!':'‚úÖ –†–∞–∑–±–∞–Ω–µ–Ω!');
    adminLoadPlayers();
  }catch(e){showToast('‚ùå '+e.message)}
}

async function adminEditPlayer(uid){
  if(!dbConnected)return;
  try{
    const snap=await db.ref('vriskas_clicker/'+uid).once('value');
    const p=snap.val();if(!p)return showToast('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω');
    
    const el=document.getElementById('adminContent');
    el.innerHTML=`
      <div class="card" style="border:2px solid var(--accent)">
        <div style="font-size:14px;font-weight:700;margin-bottom:12px">‚úèÔ∏è ${p.name||'–ò–≥—Ä–æ–∫'} (${uid})</div>
        <div style="margin-bottom:8px"><label style="font-size:11px;color:var(--text2)">–ú–æ–Ω–µ—Ç—ã</label><input class="admin-input" id="aeCoins" type="number" value="${p.coins||0}"></div>
        <div style="margin-bottom:8px"><label style="font-size:11px;color:var(--text2)">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</label><input class="admin-input" id="aeEarned" type="number" value="${p.totalEarned||0}"></div>
        <div style="margin-bottom:8px"><label style="font-size:11px;color:var(--text2)">–¢–∞–ø–æ–≤</label><input class="admin-input" id="aeTaps" type="number" value="${p.totalTaps||0}"></div>
        <div style="margin-bottom:8px"><label style="font-size:11px;color:var(--text2)">–ó–≤—ë–∑–¥—ã</label><input class="admin-input" id="aeStars" type="number" value="${p.gameStars||0}"></div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" style="font-size:12px" onclick="adminSavePlayer('${uid}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="btn btn-dark" style="font-size:12px" onclick="adminLoadPlayers()">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
      </div>
    `;
  }catch(e){showToast('‚ùå '+e.message)}
}

async function adminSavePlayer(uid){
  try{
    await db.ref('vriskas_clicker/'+uid).update({
      coins:parseInt(document.getElementById('aeCoins').value)||0,
      totalEarned:parseInt(document.getElementById('aeEarned').value)||0,
      totalTaps:parseInt(document.getElementById('aeTaps').value)||0,
      gameStars:parseInt(document.getElementById('aeStars').value)||0,
      adminForceUpdate:true,
      adminTimestamp:Date.now()
    });
    showToast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
    adminLoadPlayers();
  }catch(e){showToast('‚ùå '+e.message)}
}

async function adminDeletePlayer(uid){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞ '+uid+'?'))return;
  try{
    await db.ref('vriskas_clicker/'+uid).remove();
    showToast('üóë –£–¥–∞–ª—ë–Ω');
    adminLoadPlayers();
  }catch(e){showToast('‚ùå '+e.message)}
}

async function adminSearchPlayer(){
  const uid=document.getElementById('adminSearchId').value.trim();
  if(!uid)return;
  adminEditPlayer(uid);
}

async function adminStats(){
  const el=document.getElementById('adminContent');
  if(!dbConnected){el.innerHTML='<div style="color:var(--red)">‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';return}
  try{
    const snap=await db.ref('vriskas_clicker').once('value');
    let total=0,totalCoins=0,totalTaps=0,banned=0;
    snap.forEach(c=>{
      const d=c.val();total++;
      totalCoins+=(d.totalEarned||0);
      totalTaps+=(d.totalTaps||0);
      if(d.banned)banned++;
    });
    el.innerHTML=`
      <div class="card">
        <div style="font-size:14px;font-weight:700;margin-bottom:8px">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
        <div style="font-size:13px;color:var(--text2);line-height:2">
          üë• –ò–≥—Ä–æ–∫–æ–≤: <b style="color:var(--text)">${total}</b><br>
          üí∞ –í—Å–µ–≥–æ –º–æ–Ω–µ—Ç: <b style="color:var(--text)">${fmt(totalCoins)}</b><br>
          üëÜ –í—Å–µ–≥–æ —Ç–∞–ø–æ–≤: <b style="color:var(--text)">${fmt(totalTaps)}</b><br>
          üö´ –ó–∞–±–∞–Ω–µ–Ω–æ: <b style="color:var(--red)">${banned}</b>
        </div>
      </div>
    `;
  }catch(e){el.innerHTML='<div style="color:var(--red)">‚ùå '+e.message+'</div>'}
}

async function adminResetAll(){
  if(!confirm('–£–î–ê–õ–ò–¢–¨ –í–°–ï–• –ò–ì–†–û–ö–û–í?'))return;
  if(!confirm('–¢–û–ß–ù–û? –≠–¢–û –ù–ï–û–ë–†–ê–¢–ò–ú–û!'))return;
  try{
    await db.ref('vriskas_clicker').remove();
    showToast('üóë –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
  }catch(e){showToast('‚ùå '+e.message)}
}

// ===== FIREBASE =====
async function initFirebase(){
  try{
    await db.ref('vriskas_clicker/_ping').set(Date.now());
    dbConnected=true;
    console.log('[DB] Connected!');
    loadFromCloud();
  }catch(e){
    console.error('[DB] Error:',e);
    dbConnected=false;
  }
}

async function loadFromCloud(){
  if(!dbConnected)return;
  const uid=getUserId();
  try{
    const snap=await db.ref('vriskas_clicker/'+uid).once('value');
    const d=snap.val();
    if(!d)return;
    
    // ALWAYS check ban
    if(d.banned){
      S.banned=true;
      S.coins=0;S.totalEarned=0;S.totalTaps=0;S.gameStars=0;
      save();
      document.getElementById('bannedScreen').classList.add('show');
      return;
    }
    
    // Check admin force update
    if(d.adminForceUpdate){
      S.coins=d.coins||0;
      S.totalEarned=d.totalEarned||0;
      S.totalTaps=d.totalTaps||0;
      S.gameStars=d.gameStars||0;
      S.banned=false;
      // Clear force flag
      db.ref('vriskas_clicker/'+uid+'/adminForceUpdate').remove();
      db.ref('vriskas_clicker/'+uid+'/adminTimestamp').remove();
      save();recalcStats();updateUI();
      return;
    }
    
    // Normal sync ‚Äî take cloud if more progress
    if((d.totalEarned||0)>(S.totalEarned||0)){
      S.coins=d.coins||S.coins;
      S.totalEarned=d.totalEarned||S.totalEarned;
      S.totalTaps=d.totalTaps||S.totalTaps;
      S.gameStars=d.gameStars||S.gameStars;
      save();recalcStats();updateUI();
    }
  }catch(e){console.error('[DB] Load error:',e)}
}

async function syncToCloud(){
  if(!dbConnected||S.banned)return;
  const uid=getUserId();
  try{
    // Check ban before syncing
    const snap=await db.ref('vriskas_clicker/'+uid+'/banned').once('value');
    if(snap.val()===true){
      S.banned=true;S.coins=0;S.totalEarned=0;S.totalTaps=0;S.gameStars=0;
      save();document.getElementById('bannedScreen').classList.add('show');
      return;
    }
    
    // Check admin force update
    const forceSnap=await db.ref('vriskas_clicker/'+uid+'/adminForceUpdate').once('value');
    if(forceSnap.val()===true){
      const fullSnap=await db.ref('vriskas_clicker/'+uid).once('value');
      const d=fullSnap.val();
      if(d){
        S.coins=d.coins||0;S.totalEarned=d.totalEarned||0;
        S.totalTaps=d.totalTaps||0;S.gameStars=d.gameStars||0;
      }
      db.ref('vriskas_clicker/'+uid+'/adminForceUpdate').remove();
      save();recalcStats();updateUI();
      return;
    }
    
    await db.ref('vriskas_clicker/'+uid).update({
      tg_id:uid,
      name:getUserName(),
      username:getUserUsername(),
      photo:getUserPhoto()||'',
      coins:S.coins,
      totalEarned:S.totalEarned,
      totalTaps:S.totalTaps,
      gameStars:S.gameStars,
      level:getLevel(),
      lastSave:Date.now(),
      banned:false
    });
  }catch(e){console.error('[DB] Sync error:',e)}
}

// Ban check interval
setInterval(async()=>{
  if(!dbConnected||S.banned)return;
  try{
    const uid=getUserId();
    const snap=await db.ref('vriskas_clicker/'+uid).once('value');
    const d=snap.val();
    if(!d)return;
    if(d.banned){
      S.banned=true;S.coins=0;S.totalEarned=0;S.totalTaps=0;S.gameStars=0;
      save();document.getElementById('bannedScreen').classList.add('show');
      return;
    }
    if(d.adminForceUpdate){
      S.coins=d.coins||0;S.totalEarned=d.totalEarned||0;
      S.totalTaps=d.totalTaps||0;S.gameStars=d.gameStars||0;
      db.ref('vriskas_clicker/'+uid+'/adminForceUpdate').remove();
      save();recalcStats();updateUI();
      showToast('üì° –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∞–¥–º–∏–Ω–æ–º');
    }
  }catch(e){}
},5000);

// ===== UPDATE UI =====
function updateUI(){
  document.getElementById('headerCoins').textContent=fmt(S.coins);
  document.getElementById('headerStars').textContent=S.gameStars;
  
  const li=getLevelInfo();
  document.getElementById('headerLevel').textContent='–£—Ä.'+li.lvl+' '+li.name;
  document.getElementById('levelName').textContent='–£—Ä.'+li.lvl+' '+li.name;
  if(li.nextXp){
    const pct=Math.floor((S.totalEarned-li.xp)/(li.nextXp-li.xp)*100);
    document.getElementById('levelProg').textContent=pct+'%';
    document.getElementById('levelFill').style.width=pct+'%';
  }else{
    document.getElementById('levelProg').textContent='MAX';
    document.getElementById('levelFill').style.width='100%';
  }
  
  document.getElementById('cpsDisplay').textContent=fmt(getCPS());
  document.getElementById('perTapDisplay').textContent=fmt(S.perTap);
  document.getElementById('totalTapsDisplay').textContent=fmt(S.totalTaps);
  
  // Energy
  const ePct=Math.floor(S.energy/S.maxEnergy*100);
  document.getElementById('energyText').textContent=S.energy+'/'+S.maxEnergy;
  document.getElementById('energyFill').style.width=ePct+'%';
  document.getElementById('energyFill').classList.toggle('low',ePct<20);
  
  // Combo
  if(S.combo>0){
    document.getElementById('comboBar').style.display='block';
    const cm=1+Math.floor(S.combo/10)*0.5;
    document.getElementById('comboText').textContent='COMBO x'+cm.toFixed(1)+' ('+S.combo+' —Ç–∞–ø–æ–≤)';
    document.getElementById('comboFill').style.width='100%';
  }else{
    document.getElementById('comboBar').style.display='none';
  }
  
  updateEventBanner();
  checkAchievements();
}

// ===== GAME LOOP =====
setInterval(()=>{
  // Energy regen
  if(S.energy<S.maxEnergy){
    S.energy=Math.min(S.energy+S.regen,S.maxEnergy);
  }
  // Passive income
  if(S.cps>0){
    S.coins+=S.cps;S.totalEarned+=S.cps;
  }
  // Star gen
  if(S.starGenRate>0&&Math.random()<S.starGenRate/60){
    S.gameStars++;S.totalStarsEarned++;
  }
  // Quest progress
  if(S.dailyQuestProg){
    S.dailyQuestProg.earned=(S.dailyQuestProg.earned||0)+S.cps;
  }
  
  updateUI();
},1000);

// Auto-save
setInterval(()=>save(),30000);
// Auto-sync
setInterval(()=>syncToCloud(),30000);

// ===== BG PARTICLES =====
function initParticles(){
  const bg=document.getElementById('clickerBg');
  for(let i=0;i<8;i++){
    const p=document.createElement('div');
    p.className='clicker-bg-particle';
    const size=4+Math.random()*12;
    p.style.width=size+'px';p.style.height=size+'px';
    p.style.left=Math.random()*100+'%';p.style.top=Math.random()*100+'%';
    p.style.background=`hsl(${Math.random()*360},70%,60%)`;
    p.style.animationDelay=Math.random()*5+'s';
    p.style.animationDuration=(5+Math.random()*10)+'s';
    bg.appendChild(p);
  }
}

// ===== INIT =====
function init(){
  load();
  lastCheckedLevel=getLevel();
  
  // Apply style
  document.body.classList.add('style-'+(S.style||'ios'));
  
  // Apply skin
  const skin=SKINS.find(s=>s.id===S.activeSkin);
  if(skin)document.getElementById('coinSvg').innerHTML=skin.svg;
  
  // User info
  const photo=getUserPhoto();
  if(photo){
    document.getElementById('headerAvatar').innerHTML='<img src="'+photo+'">';
  }
  document.getElementById('headerName').textContent=getUserName();
  
  initParticles();
  initFirebase();
  updateUI();
  
  // Track daily quest progress
  const today=Math.floor(Date.now()/(24*60*60*1000));
  if(!S.dailyQuestProg||S.dailyQuestDay!==today){
    S.dailyQuestProg={};S.dailyQuestClaimed={};S.dailyQuestDay=today;
  }
}

// Track quest progress on click
const origDoClick=doClick;
doClick=function(e){
  origDoClick(e);
  if(S.dailyQuestProg){
    S.dailyQuestProg.taps=(S.dailyQuestProg.taps||0)+1;
    S.dailyQuestProg.earned=(S.dailyQuestProg.earned||0)+S.perTap;
    S.dailyQuestProg.combo=Math.max(S.dailyQuestProg.combo||0,S.combo);
  }
};

// Boss kill quest tracking
const origBossHit=bossHit;
bossHit=function(e){
  origBossHit(e);
  if(!bossState&&S.dailyQuestProg)S.dailyQuestProg.boss=(S.dailyQuestProg.boss||0)+1;
};

// Golden catch quest tracking
const origGoldenCaught=S.goldenCaught;

// Upgrade quest tracking
const origBuyUpgrade=buyUpgrade;
buyUpgrade=function(id){
  origBuyUpgrade(id);
  if(S.dailyQuestProg)S.dailyQuestProg.upgrades=(S.dailyQuestProg.upgrades||0)+1;
};

// Duel win quest tracking  
const origEndDuel=endDuel;
endDuel=function(){
  const prevWins=S.duelWins;
  origEndDuel();
  if(S.duelWins>prevWins&&S.dailyQuestProg)S.dailyQuestProg.duelWin=(S.dailyQuestProg.duelWin||0)+1;
};

// Add gradient animation
const style=document.createElement('style');
style.textContent='@keyframes gradShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}';
document.head.appendChild(style);

init();
</script>
</body>
</html>
